<!DOCTYPE html>
<html lang="pt-ao">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>HepoMarket CEO | Dashboard</title>
<link rel="stylesheet" href="win11.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
.view{display:none}.view.active{display:block}
.dash-topbar{position:sticky;top:0;z-index:80;height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 24px;background:var(--surface);backdrop-filter:blur(40px) saturate(180%);border-bottom:1px solid var(--border);}
.dash-topbar-title{font-size:16px;font-weight:700}
.notif-wrap{position:relative}
.notif-dropdown{position:absolute;top:calc(100% + 10px);right:0;width:340px;background:var(--surface-solid);border:1px solid var(--border-strong);border-radius:var(--radius-xl);box-shadow:var(--shadow-lg);z-index:200;display:none;overflow:hidden}
.notif-dropdown.open{display:block}
.notif-header{padding:14px 16px;font-weight:800;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.notif-list{max-height:340px;overflow-y:auto}
.notif-item{padding:12px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.15s}
.notif-item:hover{background:var(--surface-hover)}
.notif-item.unread{background:var(--accent-light)}
.notif-item .notif-title{font-weight:700;font-size:13px}
.notif-item .notif-body{font-size:12px;color:var(--text-secondary);margin-top:2px}
.notif-item .notif-time{font-size:11px;color:var(--text-disabled);margin-top:2px}
.icon-badge{position:absolute;top:-4px;right:-4px;background:#c42b1c;color:#fff;border-radius:10px;padding:1px 5px;font-size:10px;font-weight:800;border:2px solid var(--surface-solid);min-width:18px;text-align:center}
.chart-box{background:var(--surface-solid);border:1px solid var(--border);border-radius:var(--radius-lg);padding:20px;box-shadow:var(--shadow-sm)}
.chart-box h3{font-size:14px;font-weight:700;color:var(--text-secondary);margin-bottom:14px;text-transform:uppercase;letter-spacing:0.4px}
.img-upload{position:relative;width:100%;height:160px;border:2px dashed var(--border-strong);border-radius:var(--radius-md);cursor:pointer;overflow:hidden;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:6px;background:var(--bg);transition:all 0.2s}
.img-upload:hover{border-color:var(--accent);background:var(--accent-light)}
.img-upload img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.img-upload input{position:absolute;inset:0;opacity:0;cursor:pointer;font-size:0}
.img-upload-text{color:var(--text-secondary);font-size:13px;text-align:center;pointer-events:none;z-index:1}
.avatar-upload{position:relative;display:inline-block;cursor:pointer}
.avatar-upload input{position:absolute;inset:0;opacity:0;cursor:pointer;font-size:0}
.avatar-upload-label{position:absolute;bottom:-4px;right:-4px;background:var(--accent);color:#fff;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-size:14px;border:2px solid var(--surface-solid);pointer-events:none}
.ceo-avatar-big .avatar-img{width:96px;height:96px;border-radius:50%;object-fit:cover;border:4px solid var(--accent);box-shadow:var(--shadow-md);background:var(--accent-light);display:flex;align-items:center;justify-content:center;font-size:40px;font-weight:800;color:var(--accent);overflow:hidden}
.ceo-avatar-big .avatar-edit-btn{position:absolute;bottom:0;right:0;background:var(--accent);color:#fff;border:3px solid var(--surface-solid);border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;transition:background 0.2s}
.ceo-avatar-big .avatar-edit-btn:hover{background:var(--accent-dark)}
.color-grid{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.color-dot{width:36px;height:36px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:all 0.15s;box-shadow:var(--shadow-sm)}
.color-dot.sel{border-color:var(--text-primary);transform:scale(1.15)}
.approval-card{background:var(--surface-solid);border:1px solid var(--border);border-radius:var(--radius-lg);padding:16px;display:flex;align-items:center;gap:14px;transition:box-shadow 0.2s;margin-bottom:10px}
.approval-card:hover{box-shadow:var(--shadow-md)}
.status-pill{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:12px;font-weight:700}
.social-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
/* Convites */
.invite-card{background:var(--accent-light);border:1px solid rgba(0,120,212,0.2);border-radius:var(--radius-lg);padding:16px;margin-bottom:10px}
.invite-code{font-family:monospace;font-size:18px;font-weight:800;color:var(--accent);letter-spacing:2px}
/* BancÃ¡rio */
.bank-card{background:linear-gradient(135deg,#0078D4,#005a9e);color:#fff;border-radius:var(--radius-xl);padding:24px;margin-bottom:16px}
/* Pedido entrega */
.entrega-info{background:var(--bg2);border-radius:var(--radius-md);padding:12px;margin-top:8px;font-size:13px}
.entrega-info .ei-row{display:flex;gap:8px;margin-bottom:4px}
.entrega-info .ei-label{font-weight:700;min-width:100px}
/* Tabs */
.tabs{display:flex;gap:4px;background:var(--bg2);padding:4px;border-radius:var(--radius-md);margin-bottom:20px}
.tab-btn{flex:1;padding:8px 12px;border:none;background:transparent;border-radius:var(--radius-sm);font-weight:600;cursor:pointer;transition:all 0.15s;color:var(--text-secondary);font-family:var(--font);font-size:14px}
.tab-btn.active{background:var(--surface-solid);color:var(--text-primary);box-shadow:var(--shadow-sm)}
</style>
</head>
<body>

<!-- SIDEBAR -->
<nav class="nav-sidebar" id="sidebar">
  <div class="nav-header">
    <img class="nav-logo" src="logo.png" id="sidebar-logo" alt="Logo" onerror="this.style.display='none'">
    <span class="nav-title" id="sidebar-brand">HepoMarket</span>
  </div>
  <div class="nav-items">
    <div class="nav-item active" data-view="home" onclick="goView('home',this)">
      <span class="nav-icon">ğŸ </span><span>Painel Principal</span>
    </div>
    <div class="nav-section">GestÃ£o</div>
    <div class="nav-item" data-view="produtos" onclick="goView('produtos',this)">
      <span class="nav-icon">ğŸ“¦</span><span>Produtos</span>
      <span class="nav-badge" id="badge-prod">0</span>
    </div>
    <div class="nav-item" data-view="servicos" onclick="goView('servicos',this)">
      <span class="nav-icon">ğŸ› ï¸</span><span>ServiÃ§os</span>
      <span class="nav-badge" id="badge-serv">0</span>
    </div>
    <div class="nav-item" data-view="pedidos" onclick="goView('pedidos',this)">
      <span class="nav-icon">ğŸ›’</span><span>Pedidos</span>
      <span class="nav-badge" id="badge-ped" style="background:#d47f00">0</span>
    </div>
    <div class="nav-section">Pessoas</div>
    <div class="nav-item" data-view="clientes" onclick="goView('clientes',this)">
      <span class="nav-icon">ğŸ‘¥</span><span>Clientes</span>
      <span class="nav-badge" id="badge-cli">0</span>
    </div>
    <div class="nav-item" data-view="parceiros" onclick="goView('parceiros',this)">
      <span class="nav-icon">ğŸ¤</span><span>Parceiros & Afiliados</span>
      <span class="nav-badge" id="badge-par">0</span>
    </div>
    <div class="nav-item" data-view="aprovacoes" onclick="goView('aprovacoes',this)">
      <span class="nav-icon">âœ…</span><span>AprovaÃ§Ãµes</span>
      <span class="nav-badge" id="badge-aprov" style="background:#c42b1c">0</span>
    </div>
    <div class="nav-section">Ferramentas</div>
    <div class="nav-item" data-view="convites" onclick="goView('convites',this)">
      <span class="nav-icon">ğŸ”—</span><span>Convites</span>
      <span class="nav-badge" id="badge-conv" style="background:#8764b8">0</span>
    </div>
    <div class="nav-item" data-view="bancario" onclick="goView('bancario',this)">
      <span class="nav-icon">ğŸ¦</span><span>Dados BancÃ¡rios</span>
    </div>
    <div class="nav-item" data-view="cupoes" onclick="goView('cupoes',this)">
      <span class="nav-icon">ğŸŸï¸</span><span>CupÃµes de Desconto</span>
      <span class="nav-badge" id="badge-cup" style="background:#107c10">0</span>
    </div>
    <div class="nav-section">Sistema</div>
    <div class="nav-item" data-view="mensagens" onclick="goView('mensagens',this)">
      <span class="nav-icon">âœ‰ï¸</span><span>Mensagens</span>
      <span class="nav-badge" id="badge-msg" style="background:#107c10">0</span>
    </div>
    <div class="nav-item" data-view="perfil" onclick="goView('perfil',this)">
      <span class="nav-icon">ğŸ‘¤</span><span>Perfil CEO</span>
    </div>
    <div class="nav-item" data-view="configuracoes" onclick="goView('configuracoes',this)">
      <span class="nav-icon">âš™ï¸</span><span>DefiniÃ§Ãµes</span>
    </div>
    <div class="nav-item" onclick="verSite()">
      <span class="nav-icon">ğŸŒ</span><span>Ver Site PÃºblico</span>
    </div>
  </div>
  <div class="nav-footer">
    <div class="nav-item" onclick="logout()" style="color:#c42b1c">
      <span class="nav-icon">ğŸšª</span><span>Terminar SessÃ£o</span>
    </div>
  </div>
</nav>

<!-- MAIN -->
<div class="main-content">

  <!-- TOPBAR -->
  <div class="dash-topbar">
    <div style="display:flex;align-items:center;gap:12px">
      <span class="dash-topbar-title" id="topbar-title">Painel Principal</span>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <button class="btn btn-ghost btn-icon" title="Actualizar" onclick="refreshView()" id="btn-refresh" style="font-size:18px">ğŸ”„</button>
      <button class="btn btn-ghost btn-icon" title="Alternar Tema" onclick="toggleTema()" id="btn-tema" style="font-size:18px">ğŸŒ™</button>
      <!-- NotificaÃ§Ãµes -->
      <div class="notif-wrap" style="position:relative">
        <button class="btn btn-ghost btn-icon" title="NotificaÃ§Ãµes" onclick="toggleNotif()" style="font-size:18px;position:relative">
          ğŸ””<span class="icon-badge" id="notif-badge" style="display:none">0</span>
        </button>
        <div class="notif-dropdown" id="notif-dropdown">
          <div class="notif-header">
            <span>ğŸ”” NotificaÃ§Ãµes</span>
            <button class="btn btn-ghost btn-sm" onclick="DB.marcarTodasLidas();renderNotifDropdown()">Marcar lidas</button>
          </div>
          <div class="notif-list" id="notif-list"></div>
        </div>
      </div>
      <!-- Mensagens badge -->
      <div style="position:relative">
        <button class="btn btn-ghost btn-icon" title="Mensagens" onclick="goView('mensagens')" style="font-size:18px;position:relative">
          âœ‰ï¸<span class="icon-badge" id="msg-badge" style="display:none">0</span>
        </button>
      </div>
      <div style="width:1px;height:24px;background:var(--border);margin:0 4px"></div>
      <div style="text-align:right;font-size:12px;color:var(--text-secondary)">
        <div id="topbar-date"></div>
        <div style="font-weight:700;color:var(--text-primary)" id="topbar-ceo-name">CEO</div>
      </div>
      <div onclick="goView('perfil')" style="cursor:pointer" title="Ver Perfil">
        <div class="avatar" id="topbar-avatar" style="width:36px;height:36px;font-size:16px;background:var(--accent);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700">M</div>
      </div>
    </div>
  </div>

  <!-- ===== VIEW: HOME ===== -->
  <div class="view active page" id="view-home">
    <div class="page-header">
      <div class="page-title" id="home-welcome">Bem-vindo ğŸ‘‹</div>
      <div class="page-subtitle" id="home-subtitle">Resumo do seu negÃ³cio em tempo real</div>
    </div>
    <div class="stat-grid" id="stat-grid"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px">
      <div class="chart-box"><h3>ğŸ“¦ Produtos por Categoria</h3><canvas id="chart-cat" height="200"></canvas></div>
      <div class="chart-box"><h3>ğŸ¤ Parceiros por Status</h3><canvas id="chart-par" height="200"></canvas></div>
    </div>
    <div style="display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-bottom:24px">
      <div class="chart-box"><h3>ğŸ“ˆ Pedidos por MÃªs</h3><canvas id="chart-monthly" height="200"></canvas></div>
      <div class="chart-box">
        <h3>âš¡ AcÃ§Ãµes RÃ¡pidas</h3>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="btn btn-primary" onclick="goView('produtos');setTimeout(openProdModal,100)">â• Adicionar Produto</button>
          <button class="btn btn-secondary" onclick="goView('pedidos');setTimeout(openPedidoModal,100)">ğŸ›’ Novo Pedido</button>
          <button class="btn btn-secondary" onclick="goView('convites')">ğŸ”— Gerar Convite</button>
          <button class="btn btn-secondary" onclick="goView('aprovacoes')">âœ… Ver AprovaÃ§Ãµes</button>
          <button class="btn btn-secondary" onclick="goView('cupoes')">ğŸŸï¸ CupÃµes de Desconto</button>
          <button class="btn btn-ghost" onclick="verSite()">ğŸŒ Ver Site PÃºblico</button>
        </div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div class="card-solid" style="padding:16px"><div style="font-weight:700;margin-bottom:12px">ğŸ›’ Ãšltimos Pedidos</div><div id="recent-pedidos"></div></div>
      <div class="card-solid" style="padding:16px"><div style="font-weight:700;margin-bottom:12px">ğŸ¤ Ãšltimos Parceiros</div><div id="recent-pars"></div></div>
    </div>
  </div>

  <!-- ===== VIEW: PRODUTOS ===== -->
  <div class="view page" id="view-produtos">
    <div class="page-header" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
      <div><div class="page-title">ğŸ“¦ Produtos</div><div class="page-subtitle">Gerir todos os produtos do catÃ¡logo</div></div>
      <button class="btn btn-primary" onclick="openProdModal()">â• Adicionar Produto</button>
    </div>
    <div style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap">
      <div class="search-box" style="flex:1;min-width:200px"><span>ğŸ”</span><input id="prod-search" placeholder="Pesquisar produto..." oninput="renderProdTable()"></div>
      <select class="select" id="prod-filter-cat" style="width:auto" onchange="renderProdTable()"><option value="">Todas as categorias</option></select>
    </div>
    <div class="table-wrap">
      <table><thead><tr><th>Imagem</th><th>Nome</th><th>Categoria</th><th>PreÃ§o</th><th>Stock</th><th>Data</th><th>AcÃ§Ãµes</th></tr></thead>
      <tbody id="prod-tbody"></tbody></table>
    </div>
  </div>

  <!-- ===== VIEW: SERVIÃ‡OS ===== -->
  <div class="view page" id="view-servicos">
    <div class="page-header" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
      <div><div class="page-title">ğŸ› ï¸ ServiÃ§os</div><div class="page-subtitle">Gerir todos os serviÃ§os oferecidos</div></div>
      <button class="btn btn-primary" onclick="openServModal()">â• Adicionar ServiÃ§o</button>
    </div>
    <div class="table-wrap">
      <table><thead><tr><th>Ãcone</th><th>Nome</th><th>DescriÃ§Ã£o</th><th>PreÃ§o</th><th>Data</th><th>AcÃ§Ãµes</th></tr></thead>
      <tbody id="serv-tbody"></tbody></table>
    </div>
  </div>

  <!-- ===== VIEW: PEDIDOS ===== -->
  <div class="view page" id="view-pedidos">
    <div class="page-header" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
      <div><div class="page-title">ğŸ›’ Pedidos</div><div class="page-subtitle">Gerir e acompanhar todos os pedidos</div></div>
      <button class="btn btn-primary" onclick="openPedidoModal()">â• Registar Pedido</button>
    </div>
    <div style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap">
      <div class="search-box" style="flex:1;min-width:200px"><span>ğŸ”</span><input id="ped-search" placeholder="Pesquisar pedido..." oninput="renderPedidos()"></div>
      <select class="select" id="ped-filter" style="width:auto" onchange="renderPedidos()">
        <option value="">Todos os status</option>
        <option value="pendente">â³ Pendente</option>
        <option value="confirmado">âœ… Confirmado</option>
        <option value="entregue">ğŸ“¦ Entregue</option>
        <option value="cancelado">âŒ Cancelado</option>
      </select>
    </div>
    <div id="pedidos-list"></div>
  </div>

  <!-- ===== VIEW: CLIENTES ===== -->
  <div class="view page" id="view-clientes">
    <div class="page-header" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
      <div><div class="page-title">ğŸ‘¥ Clientes</div><div class="page-subtitle">Todos os clientes registados</div></div>
      <button class="btn btn-primary" onclick="openCliModal()">â• Adicionar Cliente</button>
    </div>
    <div class="search-box" style="margin-bottom:20px"><span>ğŸ”</span><input id="cli-search" placeholder="Pesquisar cliente..." oninput="renderClientes()"></div>
    <div class="profile-grid" id="cli-grid"></div>
  </div>

  <!-- ===== VIEW: PARCEIROS ===== -->
  <div class="view page" id="view-parceiros">
    <div class="page-header" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
      <div><div class="page-title">ğŸ¤ Parceiros & Afiliados</div><div class="page-subtitle">Gerir rede de parceiros e afiliados</div></div>
      <button class="btn btn-primary" onclick="openParModal()">â• Adicionar Parceiro</button>
    </div>
    <div style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap">
      <div class="search-box" style="flex:1;min-width:200px"><span>ğŸ”</span><input id="par-search" placeholder="Pesquisar parceiro..." oninput="renderParceiros()"></div>
      <select class="select" id="par-filter" style="width:auto" onchange="renderParceiros()">
        <option value="">Todos os status</option>
        <option value="pendente">â³ Pendente</option>
        <option value="ativo">âœ… Activo</option>
        <option value="rejeitado">âŒ Rejeitado</option>
      </select>
    </div>
    <div class="profile-grid" id="par-grid"></div>
  </div>

  <!-- ===== VIEW: APROVAÃ‡Ã•ES ===== -->
  <div class="view page" id="view-aprovacoes">
    <div class="page-header"><div class="page-title">âœ… AprovaÃ§Ãµes Pendentes</div><div class="page-subtitle">Parceiros e pedidos que aguardam decisÃ£o do CEO</div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
      <div>
        <div style="font-weight:800;font-size:16px;margin-bottom:16px">ğŸ¤ Parceiros Pendentes</div>
        <div id="aprovacoes-parceiros"></div>
      </div>
      <div>
        <div style="font-weight:800;font-size:16px;margin-bottom:16px">ğŸ›’ Pedidos Pendentes</div>
        <div id="aprovacoes-pedidos"></div>
      </div>
    </div>
  </div>

  <!-- ===== VIEW: CONVITES ===== -->
  <div class="view page" id="view-convites">
    <div class="page-header"><div class="page-title">ğŸ”— Convites</div><div class="page-subtitle">Gerar links de convite para parceiros ou clientes</div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:28px">
      <div class="card-solid" style="padding:28px;text-align:center">
        <div style="font-size:48px;margin-bottom:12px">ğŸ¤</div>
        <div style="font-size:18px;font-weight:800;margin-bottom:8px">Convite de Parceiro</div>
        <div style="color:var(--text-secondary);font-size:13px;margin-bottom:20px">Gera um link para alguÃ©m se registar como afiliado/parceiro. O registo fica pendente para aprovaÃ§Ã£o do CEO.</div>
        <button class="btn btn-primary btn-lg" style="width:100%" onclick="gerarConvite('parceiro')">ğŸ”— Gerar Link de Parceiro</button>
      </div>
      <div class="card-solid" style="padding:28px;text-align:center">
        <div style="font-size:48px;margin-bottom:12px">ğŸ‘¤</div>
        <div style="font-size:18px;font-weight:800;margin-bottom:8px">Convite de Cliente</div>
        <div style="color:var(--text-secondary);font-size:13px;margin-bottom:20px">Gera um link para alguÃ©m se registar como cliente directo. Acesso imediato ao painel de cliente.</div>
        <button class="btn btn-success btn-lg" style="width:100%" onclick="gerarConvite('cliente')">ğŸ”— Gerar Link de Cliente</button>
      </div>
    </div>
    <div style="font-weight:800;font-size:16px;margin-bottom:16px">ğŸ“‹ HistÃ³rico de Convites</div>
    <div id="convites-list"></div>
  </div>

  <!-- ===== VIEW: BANCÃRIO ===== -->
  <div class="view page" id="view-bancario">
    <div class="page-header"><div class="page-title">ğŸ¦ Dados BancÃ¡rios</div><div class="page-subtitle">Configurar mÃ©todos de pagamento aceites</div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
      <!-- Preview CartÃ£o -->
      <div>
        <div class="bank-card" id="bank-card-preview">
          <div style="font-size:13px;opacity:0.7;margin-bottom:4px">HEPOMARKET</div>
          <div style="font-size:20px;font-weight:800;letter-spacing:2px;margin-bottom:16px" id="bk-iban-display">IBAN nÃ£o configurado</div>
          <div style="display:flex;justify-content:space-between;align-items:flex-end">
            <div>
              <div style="font-size:11px;opacity:0.7">TITULAR</div>
              <div style="font-weight:700" id="bk-titular-display">â€”</div>
            </div>
            <div style="text-align:right">
              <div style="font-size:11px;opacity:0.7">BANCO</div>
              <div style="font-weight:700" id="bk-banco-display">â€”</div>
            </div>
          </div>
        </div>
        <!-- Multicaixa -->
        <div class="card-solid" style="padding:20px;margin-bottom:16px">
          <div style="font-weight:800;margin-bottom:16px">ğŸ“± Multicaixa Express</div>
          <div class="form-group"><label class="label">NÃºmero Multicaixa</label><input class="input" id="bk-multicaixa" placeholder="9XX XXX XXX" oninput="updateBankPreview()"></div>
          <div class="form-group"><label class="label">ReferÃªncia (opcional)</label><input class="input" id="bk-ref-multicaixa" placeholder="ReferÃªncia Multicaixa"></div>
        </div>
        <!-- PayPal / Outro -->
        <div class="card-solid" style="padding:20px">
          <div style="font-weight:800;margin-bottom:16px">ğŸ’³ Outros MÃ©todos</div>
          <div class="form-group"><label class="label">PayPal</label><input class="input" id="bk-paypal" placeholder="email@paypal.com"></div>
          <div class="form-group"><label class="label">Outro (descreva)</label><input class="input" id="bk-outro" placeholder="Ex: Conta M-Pesa, Conta Movel..."></div>
        </div>
      </div>
      <!-- FormulÃ¡rio IBAN -->
      <div>
        <div class="card-solid" style="padding:24px;margin-bottom:16px">
          <div style="font-weight:800;font-size:16px;margin-bottom:20px">ğŸ¦ Dados IBAN / Conta BancÃ¡ria</div>
          <div class="form-group"><label class="label">IBAN</label><input class="input" id="bk-iban" placeholder="AO06 0040 0000 XXXX XXXX XXXX X" oninput="updateBankPreview()"></div>
          <div class="form-group"><label class="label">Titular da Conta</label><input class="input" id="bk-titular" placeholder="Nome completo" oninput="updateBankPreview()"></div>
          <div class="form-group"><label class="label">Banco</label><input class="input" id="bk-banco" placeholder="Ex: BAI, BFA, BIC, Atlantico..." oninput="updateBankPreview()"></div>
          <div class="form-group"><label class="label">SWIFT / BIC (opcional)</label><input class="input" id="bk-swift" placeholder="Ex: BAIIANG2"></div>
        </div>
        <!-- MÃ©todos aceites -->
        <div class="card-solid" style="padding:24px;margin-bottom:16px">
          <div style="font-weight:800;font-size:16px;margin-bottom:16px">âœ… MÃ©todos Aceites</div>
          <div style="display:flex;flex-direction:column;gap:12px">
            <label style="display:flex;align-items:center;gap:12px;cursor:pointer">
              <label class="toggle"><input type="checkbox" id="bk-m-iban"><span class="toggle-slider"></span></label>
              <span>ğŸ¦ TransferÃªncia IBAN</span>
            </label>
            <label style="display:flex;align-items:center;gap:12px;cursor:pointer">
              <label class="toggle"><input type="checkbox" id="bk-m-multicaixa"><span class="toggle-slider"></span></label>
              <span>ğŸ“± Multicaixa Express</span>
            </label>
            <label style="display:flex;align-items:center;gap:12px;cursor:pointer">
              <label class="toggle"><input type="checkbox" id="bk-m-paypal"><span class="toggle-slider"></span></label>
              <span>ğŸ’³ PayPal</span>
            </label>
            <label style="display:flex;align-items:center;gap:12px;cursor:pointer">
              <label class="toggle"><input type="checkbox" id="bk-m-dinheiro"><span class="toggle-slider"></span></label>
              <span>ğŸ’µ Dinheiro (presencial)</span>
            </label>
          </div>
        </div>
        <!-- InstruÃ§Ãµes -->
        <div class="card-solid" style="padding:24px">
          <div style="font-weight:800;margin-bottom:12px">ğŸ“‹ InstruÃ§Ãµes de Pagamento</div>
          <textarea class="textarea" id="bk-instrucoes" rows="3" placeholder="Ex: ApÃ³s o pagamento, envie o comprovativo via WhatsApp..."></textarea>
          <button class="btn btn-primary" style="width:100%;margin-top:12px" onclick="saveBancario()">ğŸ’¾ Guardar Dados BancÃ¡rios</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== VIEW: MENSAGENS ===== -->
  <div class="view page" id="view-mensagens">
    <div class="page-header"><div class="page-title">âœ‰ï¸ Mensagens</div><div class="page-subtitle">Mensagens recebidas pelo chat do site</div></div>
    <div id="mensagens-list"></div>
  </div>

  <!-- ===== VIEW: CUPÃ•ES ===== -->
  <div class="view page" id="view-cupoes">
    <div class="page-header" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
      <div><div class="page-title">ğŸŸï¸ CupÃµes de Desconto</div><div class="page-subtitle">Criar e gerir cÃ³digos de desconto para clientes</div></div>
      <button class="btn btn-primary" onclick="openCupaoModal()">â• Novo CupÃ£o</button>
    </div>
    <div class="stat-grid" id="cup-stats" style="margin-bottom:20px"></div>
    <div id="cupoes-table"></div>
  </div>

  <!-- ===== VIEW: PERFIL CEO ===== -->
  <div class="view page" id="view-perfil">
    <div class="page-header"><div class="page-title">ğŸ‘¤ Perfil CEO</div><div class="page-subtitle">Gerir as suas informaÃ§Ãµes pessoais e credenciais</div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
      <div class="card-solid" style="padding:28px">
        <div style="font-weight:800;font-size:16px;margin-bottom:20px">ğŸ“· Foto e Dados</div>
        <div style="display:flex;flex-direction:column;align-items:center;gap:16px;margin-bottom:24px">
          <div class="ceo-avatar-big" style="position:relative">
            <div class="avatar-img" id="ceo-avatar-display">M</div>
            <label class="avatar-edit-btn" title="Alterar foto">
              ğŸ“·<input type="file" accept="image/*" style="display:none" onchange="loadCeoFoto(event)">
            </label>
          </div>
          <div style="text-align:center">
            <div style="font-size:18px;font-weight:800" id="perfil-nome-display">Maximino Vicetaca</div>
            <div style="color:var(--text-secondary);font-size:13px" id="perfil-cargo-display">CEO & Fundador</div>
          </div>
          <button class="btn btn-ghost btn-sm" id="btn-remover-foto" onclick="removerCeoFoto()" style="display:none">âœ• Remover foto</button>
        </div>
        <div class="form-group"><label class="label">Nome</label><input class="input" id="ceo-nome-input" placeholder="Nome completo"></div>
        <div class="form-group"><label class="label">Cargo</label><input class="input" id="ceo-cargo-input" placeholder="Ex: CEO & Fundador"></div>
        <div class="form-group"><label class="label">Telefone</label><input class="input" id="ceo-tel-input" placeholder="+244 9XX XXX XXX"></div>
        <button class="btn btn-primary" onclick="salvarPerfil()">ğŸ’¾ Guardar Perfil</button>
      </div>
      <div class="card-solid" style="padding:28px">
        <div style="font-weight:800;font-size:16px;margin-bottom:20px">ğŸ” Credenciais de Acesso</div>
        <div class="form-group"><label class="label">Utilizador actual</label><input class="input" id="ceo-user-actual" readonly style="opacity:0.6"></div>
        <div class="form-group"><label class="label">Novo Utilizador</label><input class="input" id="new-user" placeholder="Novo utilizador"></div>
        <div style="margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid var(--border)">
          <button class="btn btn-secondary" onclick="alterarUtilizador()">ğŸ‘¤ Alterar Utilizador</button>
        </div>
        <div class="form-group"><label class="label">Palavra-passe actual</label><input class="input" id="current-pass" type="password" placeholder="Palavra-passe actual"></div>
        <div class="form-group"><label class="label">Nova Palavra-passe</label><input class="input" id="new-pass" type="password" placeholder="Nova palavra-passe (mÃ­n. 6 chars)"></div>
        <div class="form-group"><label class="label">Confirmar</label><input class="input" id="conf-pass" type="password" placeholder="Confirmar nova palavra-passe"></div>
        <button class="btn btn-primary" onclick="alterarSenha()">ğŸ”‘ Alterar Palavra-passe</button>
        <div style="margin-top:28px;padding-top:20px;border-top:1px solid var(--border)">
          <div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">âš ï¸ Repor todos os dados (irreversÃ­vel)</div>
          <button class="btn btn-danger btn-sm" onclick="confirmarReset()">ğŸ—‘ï¸ Repor Base de Dados</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== VIEW: CONFIGURAÃ‡Ã•ES ===== -->
  <div class="view page" id="view-configuracoes">
    <div class="page-header"><div class="page-title">âš™ï¸ DefiniÃ§Ãµes</div><div class="page-subtitle">Personalizar o site e o painel do CEO</div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
      <div class="card-solid" style="padding:24px">
        <div style="font-weight:800;font-size:16px;margin-bottom:20px">ğŸ¢ InformaÃ§Ãµes da Empresa</div>
        <div class="form-group"><label class="label">Nome da Empresa</label><input class="input" id="cfg-nome" placeholder="HepoMarket"></div>
        <div class="form-group"><label class="label">Slogan</label><input class="input" id="cfg-slogan" placeholder="Renda Extra com SeguranÃ§a"></div>
        <div class="form-group"><label class="label">WhatsApp CEO (cÃ³digo do paÃ­s)</label><input class="input" id="cfg-wa" placeholder="244952100356"></div>
        <div class="form-group"><label class="label">Telefone (exibiÃ§Ã£o)</label><input class="input" id="cfg-tel" placeholder="+244 952 100 356"></div>
        <div class="form-group"><label class="label">EndereÃ§o</label><input class="input" id="cfg-endereco" placeholder="Cacuaco, Luanda, Angola"></div>
        <div class="form-group"><label class="label">ComissÃ£o padrÃ£o afiliados (%)</label><input class="input" type="number" id="cfg-comissao" placeholder="10" min="0" max="100"></div>
        <button class="btn btn-primary" onclick="saveEmpresa()">ğŸ’¾ Guardar</button>
      </div>
      <div class="card-solid" style="padding:24px">
        <div style="font-weight:800;font-size:16px;margin-bottom:20px">ğŸ“± Redes Sociais</div>
        <div class="social-grid">
          <div class="form-group"><label class="label">ğŸ“˜ Facebook</label><input class="input" id="cfg-facebook" placeholder="https://facebook.com/..."></div>
          <div class="form-group"><label class="label">ğŸ“· Instagram</label><input class="input" id="cfg-instagram" placeholder="https://instagram.com/..."></div>
          <div class="form-group"><label class="label">ğŸµ TikTok</label><input class="input" id="cfg-tiktok" placeholder="https://tiktok.com/..."></div>
          <div class="form-group"><label class="label">â–¶ï¸ YouTube</label><input class="input" id="cfg-youtube" placeholder="https://youtube.com/..."></div>
        </div>
        <button class="btn btn-primary" onclick="saveSociais()">ğŸ’¾ Guardar Redes Sociais</button>
      </div>
      <div class="card-solid" style="padding:24px">
        <div style="font-weight:800;font-size:16px;margin-bottom:20px">ğŸ¨ AparÃªncia</div>
        <div class="form-group">
          <label class="label">Tema do Painel</label>
          <div style="display:flex;gap:12px;margin-top:8px">
            <button class="btn" id="btn-light" onclick="setTema('light')" style="flex:1">â˜€ï¸ Claro</button>
            <button class="btn" id="btn-dark" onclick="setTema('dark')" style="flex:1">ğŸŒ™ Escuro</button>
          </div>
        </div>
        <div class="form-group">
          <label class="label">Cor de Acento</label>
          <div class="color-grid" id="color-grid"></div>
          <div style="margin-top:10px;display:flex;align-items:center;gap:8px">
            <input type="color" id="custom-color" class="input" style="width:48px;height:36px;padding:2px;cursor:pointer">
            <button class="btn btn-secondary btn-sm" onclick="setCustomColor()">Cor personalizada</button>
          </div>
        </div>
      </div>
      <div class="card-solid" style="padding:24px">
        <div style="font-weight:800;font-size:16px;margin-bottom:20px">ğŸ–¼ï¸ Fundo & Texto do Site PÃºblico</div>
        <div class="form-group">
          <label class="label">Tipo de Fundo</label>
          <select class="select" id="cfg-fundo-tipo" onchange="updateBgPreview()">
            <option value="gradiente">ğŸŒˆ Gradiente de cor</option>
            <option value="cor-solida">ğŸ¨ Cor SÃ³lida</option>
            <option value="imagem">ğŸ–¼ï¸ Imagem de fundo</option>
          </select>
        </div>
        <div id="fundo-gradiente-opts">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div class="form-group"><label class="label">Cor 1</label><input type="color" class="input" id="cfg-cor1" style="height:40px;cursor:pointer" oninput="updateBgPreview()"></div>
            <div class="form-group"><label class="label">Cor 2</label><input type="color" class="input" id="cfg-cor2" style="height:40px;cursor:pointer" oninput="updateBgPreview()"></div>
          </div>
        </div>
        <div id="fundo-img-opts" style="display:none">
          <div class="img-upload" onclick="document.getElementById('bg-file').click()" style="height:110px">
            <input type="file" id="bg-file" accept="image/*" style="display:none" onchange="loadBgImage(event)">
            <div class="img-upload-text" id="bg-upload-label"><span style="font-size:32px">ğŸ–¼ï¸</span><br>Clique para carregar imagem</div>
            <img id="bg-preview-img" src="" style="display:none;position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border-radius:inherit">
          </div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('bg-file').click()">ğŸ“‚ Escolher imagem</button>
            <button class="btn btn-danger btn-sm" onclick="removerImagemFundo()">ğŸ—‘ï¸ Remover</button>
          </div>
        </div>
        <div id="bg-preview-box" style="height:72px;border-radius:10px;margin:12px 0;border:1px solid var(--border)"></div>
        <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
        <div style="font-weight:700;font-size:14px;margin-bottom:12px">ğŸ”¡ Texto do Hero (pÃ¡gina inicial)</div>
        <div class="form-group">
          <label class="label">Cor do texto</label>
          <div style="display:flex;align-items:center;gap:10px">
            <input type="color" id="cfg-hero-cor-texto" class="input" style="width:56px;height:40px;padding:2px;cursor:pointer" value="#ffffff">
            <div style="display:flex;gap:6px;flex-wrap:wrap">
              <button class="btn btn-secondary btn-sm" onclick="setHeroTextCor('#ffffff')">â¬œ Branco</button>
              <button class="btn btn-secondary btn-sm" onclick="setHeroTextCor('#000000')">â¬› Preto</button>
              <button class="btn btn-secondary btn-sm" onclick="setHeroTextCor('#ffd700')">ğŸŸ¡ Dourado</button>
              <button class="btn btn-secondary btn-sm" onclick="setHeroTextCor('#222222')">ğŸ©¶ Escuro</button>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="label">Escurecimento (overlay) sobre imagem/cor</label>
          <div style="display:flex;align-items:center;gap:10px">
            <input type="checkbox" id="cfg-hero-overlay" checked style="width:18px;height:18px;accent-color:var(--accent)">
            <label for="cfg-hero-overlay" style="font-size:13px">Activar overlay de contraste</label>
          </div>
          <input type="range" id="cfg-overlay-opac" min="0" max="0.85" step="0.05" value="0.45" style="width:100%;margin-top:8px" oninput="document.getElementById('opac-val').textContent=Math.round(this.value*100)+'%'">
          <div style="font-size:12px;color:var(--text-secondary)">Intensidade: <span id="opac-val">45%</span></div>
        </div>
        <button class="btn btn-primary" onclick="saveFundo()">ğŸ’¾ Guardar Fundo & Texto</button>
      </div>
    </div>
  </div>

</div><!-- /main-content -->

<!-- ======================== MODALS ======================== -->

<!-- Modal Produto -->
<div class="modal-overlay" id="modal-prod">
<div class="modal">
  <div class="modal-header"><div class="modal-title" id="modal-prod-title">Adicionar Produto</div><button class="btn btn-ghost btn-icon" onclick="closeModal('modal-prod')">âœ•</button></div>
  <div class="modal-body">
    <input type="hidden" id="prod-edit-id">
    <div class="form-group">
      <label class="label">Imagem do Produto</label>
      <div class="img-upload" onclick="document.getElementById('prod-img-file').click()">
        <input type="file" id="prod-img-file" accept="image/*" style="display:none" onchange="loadProdImg(event)">
        <img id="prod-img-preview" src="" style="display:none;position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:1">
        <div class="img-upload-text" id="prod-img-text"><span style="font-size:32px">ğŸ“·</span><br>Clique para adicionar imagem</div>
      </div>
      <button class="btn btn-ghost btn-sm" id="prod-img-clear" style="margin-top:6px;display:none" onclick="clearProdImg()">âœ• Remover imagem</button>
    </div>
    <div class="grid-2">
      <div class="form-group"><label class="label">Nome *</label><input class="input" id="prod-nome" placeholder="Nome do produto"></div>
      <div class="form-group"><label class="label">Categoria</label><input class="input" id="prod-cat" list="cat-list" placeholder="Ex: Tecnologia"><datalist id="cat-list"></datalist></div>
    </div>
    <div class="grid-2">
      <div class="form-group"><label class="label">PreÃ§o (Kz)</label><input class="input" id="prod-preco" type="number" placeholder="0.00" min="0"></div>
      <div class="form-group"><label class="label">Stock</label><input class="input" id="prod-stock" type="number" placeholder="Quantidade"></div>
    </div>
    <div class="form-group"><label class="label">DescriÃ§Ã£o</label><textarea class="textarea" id="prod-desc" placeholder="DescriÃ§Ã£o detalhada..."></textarea></div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="closeModal('modal-prod')">Cancelar</button>
    <button class="btn btn-primary" onclick="saveProd()">ğŸ’¾ Guardar</button>
  </div>
</div></div>

<!-- Modal ServiÃ§o -->
<div class="modal-overlay" id="modal-serv">
<div class="modal">
  <div class="modal-header"><div class="modal-title" id="modal-serv-title">Adicionar ServiÃ§o</div><button class="btn btn-ghost btn-icon" onclick="closeModal('modal-serv')">âœ•</button></div>
  <div class="modal-body">
    <input type="hidden" id="serv-edit-id">
    <div class="grid-2">
      <div class="form-group"><label class="label">Nome *</label><input class="input" id="serv-nome" placeholder="Ex: Consultoria"></div>
      <div class="form-group"><label class="label">Ãcone (emoji)</label><input class="input" id="serv-icon" placeholder="ğŸ› ï¸" maxlength="4"></div>
    </div>
    <div class="form-group"><label class="label">PreÃ§o (Kz)</label><input class="input" id="serv-preco" type="number" placeholder="0.00" min="0"></div>
    <div class="form-group"><label class="label">DescriÃ§Ã£o</label><textarea class="textarea" id="serv-desc" placeholder="DescriÃ§Ã£o do serviÃ§o..."></textarea></div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="closeModal('modal-serv')">Cancelar</button>
    <button class="btn btn-primary" onclick="saveServ()">ğŸ’¾ Guardar</button>
  </div>
</div></div>

<!-- Modal Cliente -->
<div class="modal-overlay" id="modal-cli">
<div class="modal">
  <div class="modal-header"><div class="modal-title" id="modal-cli-title">Adicionar Cliente</div><button class="btn btn-ghost btn-icon" onclick="closeModal('modal-cli')">âœ•</button></div>
  <div class="modal-body">
    <input type="hidden" id="cli-edit-id">
    <div class="form-group" style="display:flex;justify-content:center">
      <label class="avatar-upload">
        <div class="avatar avatar-lg" id="cli-avatar-preview" style="cursor:pointer">ğŸ‘¤</div>
        <input type="file" accept="image/*" onchange="loadCliAvatar(event)">
        <span class="avatar-upload-label">ğŸ“·</span>
      </label>
    </div>
    <input type="hidden" id="cli-foto">
    <div class="grid-2">
      <div class="form-group"><label class="label">Nome *</label><input class="input" id="cli-nome" placeholder="Nome completo"></div>
      <div class="form-group"><label class="label">Telefone</label><input class="input" id="cli-tel" type="tel" placeholder="9XX XXX XXX"></div>
    </div>
    <div class="form-group"><label class="label">Email</label><input class="input" id="cli-email" type="email" placeholder="email@exemplo.com"></div>
    <div class="grid-2">
      <div class="form-group"><label class="label">ProvÃ­ncia</label><input class="input" id="cli-prov" placeholder="Ex: Luanda"></div>
      <div class="form-group"><label class="label">MunicÃ­pio</label><input class="input" id="cli-municipio" placeholder="Ex: Cacuaco"></div>
    </div>
    <div class="form-group"><label class="label">EndereÃ§o / Bairro</label><input class="input" id="cli-endereco" placeholder="Ex: Bairro Popular, Rua 5, Casa 12"></div>
    <div class="form-group"><label class="label">Interesse</label><input class="input" id="cli-interesse" placeholder="Ex: Produto X"></div>
    <div class="form-group"><label class="label">Notas</label><textarea class="textarea" id="cli-notas" placeholder="ObservaÃ§Ãµes..."></textarea></div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="closeModal('modal-cli')">Cancelar</button>
    <button class="btn btn-primary" onclick="saveCli()">ğŸ’¾ Guardar</button>
  </div>
</div></div>

<!-- Modal Parceiro -->
<div class="modal-overlay" id="modal-par">
<div class="modal">
  <div class="modal-header"><div class="modal-title" id="modal-par-title">Adicionar Parceiro</div><button class="btn btn-ghost btn-icon" onclick="closeModal('modal-par')">âœ•</button></div>
  <div class="modal-body">
    <input type="hidden" id="par-edit-id">
    <div class="form-group" style="display:flex;justify-content:center">
      <label class="avatar-upload">
        <div class="avatar avatar-lg" id="par-avatar-preview" style="cursor:pointer">ğŸ‘¤</div>
        <input type="file" accept="image/*" onchange="loadParAvatar(event)">
        <span class="avatar-upload-label">ğŸ“·</span>
      </label>
    </div>
    <input type="hidden" id="par-foto">
    <div class="grid-2">
      <div class="form-group"><label class="label">Nome *</label><input class="input" id="par-nome" placeholder="Nome completo"></div>
      <div class="form-group"><label class="label">Telefone</label><input class="input" id="par-tel" type="tel" placeholder="9XX XXX XXX"></div>
    </div>
    <div class="form-group"><label class="label">Email</label><input class="input" id="par-email" type="email" placeholder="email@exemplo.com"></div>
    <div class="grid-2">
      <div class="form-group"><label class="label">ProvÃ­ncia</label><input class="input" id="par-prov" placeholder="Ex: Luanda"></div>
      <div class="form-group"><label class="label">Status</label>
        <select class="select" id="par-status">
          <option value="pendente">â³ Pendente</option>
          <option value="ativo">âœ… Activo</option>
          <option value="rejeitado">âŒ Rejeitado</option>
        </select>
      </div>
    </div>
    <div class="form-group"><label class="label">ComissÃ£o (%)</label><input class="input" id="par-comissao" type="number" min="0" max="100" placeholder="Ex: 10"></div>
    <div class="form-group"><label class="label">Notas</label><textarea class="textarea" id="par-notas" placeholder="ObservaÃ§Ãµes..."></textarea></div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="closeModal('modal-par')">Cancelar</button>
    <button class="btn btn-primary" onclick="savePar()">ğŸ’¾ Guardar</button>
  </div>
</div></div>

<!-- Modal Pedido (com dados de entrega completos) -->
<div class="modal-overlay" id="modal-pedido">
<div class="modal" style="max-width:640px">
  <div class="modal-header"><div class="modal-title" id="modal-pedido-title">Registar Pedido</div><button class="btn btn-ghost btn-icon" onclick="closeModal('modal-pedido')">âœ•</button></div>
  <div class="modal-body">
    <input type="hidden" id="pedido-edit-id">
    <div style="font-weight:700;margin-bottom:12px;color:var(--accent)">ğŸ“¦ Produto/ServiÃ§o</div>
    <div class="grid-2">
      <div class="form-group"><label class="label">Produto / ServiÃ§o *</label><input class="input" id="ped-produto" placeholder="Nome do produto"></div>
      <div class="form-group"><label class="label">Valor Total (Kz)</label><input class="input" id="ped-valor" type="number" min="0" placeholder="0.00"></div>
    </div>
    <div class="form-group"><label class="label">Quantidade</label><input class="input" id="ped-qtd" type="number" min="1" value="1" placeholder="1"></div>
    <hr class="divider">
    <div style="font-weight:700;margin-bottom:12px;color:var(--accent)">ğŸ‘¤ Dados do Cliente</div>
    <div class="grid-2">
      <div class="form-group"><label class="label">Nome do Cliente *</label><input class="input" id="ped-nome-cliente" placeholder="Nome completo"></div>
      <div class="form-group"><label class="label">Telefone *</label><input class="input" id="ped-tel-cliente" type="tel" placeholder="9XX XXX XXX"></div>
    </div>
    <div class="form-group"><label class="label">Email</label><input class="input" id="ped-email-cliente" type="email" placeholder="email@exemplo.com"></div>
    <hr class="divider">
    <div style="font-weight:700;margin-bottom:12px;color:var(--accent)">ğŸ“ InformaÃ§Ãµes de Entrega</div>
    <div class="grid-2">
      <div class="form-group"><label class="label">ProvÃ­ncia *</label>
        <select class="select" id="ped-provincia">
          <option value="">Selecione...</option>
          <option>Luanda</option><option>Benguela</option><option>Huambo</option>
          <option>Cabinda</option><option>Malanje</option><option>UÃ­ge</option>
          <option>Lunda Norte</option><option>Lunda Sul</option><option>Moxico</option>
          <option>Cuando Cubango</option><option>Cunene</option><option>Namibe</option>
          <option>HuÃ­la</option><option>BiÃ©</option><option>Kwanza Sul</option>
          <option>Kwanza Norte</option><option>Bengo</option><option>Zaire</option>
        </select>
      </div>
      <div class="form-group"><label class="label">MunicÃ­pio</label><input class="input" id="ped-municipio" placeholder="Ex: Cacuaco"></div>
    </div>
    <div class="form-group"><label class="label">Bairro / EndereÃ§o completo *</label><input class="input" id="ped-endereco" placeholder="Ex: Bairro Popular, Rua 5, Casa nÂº 12"></div>
    <div class="form-group"><label class="label">Ponto de referÃªncia</label><input class="input" id="ped-referencia" placeholder="Ex: Perto da Igreja Metodista"></div>
    <hr class="divider">
    <div style="font-weight:700;margin-bottom:12px;color:var(--accent)">ğŸ’³ Pagamento</div>
    <div class="grid-2">
      <div class="form-group"><label class="label">MÃ©todo de Pagamento</label>
        <select class="select" id="ped-pagamento">
          <option value="">NÃ£o especificado</option>
          <option>IBAN / TransferÃªncia</option>
          <option>Multicaixa Express</option>
          <option>PayPal</option>
          <option>Dinheiro (presencial)</option>
          <option>Outro</option>
        </select>
      </div>
      <div class="form-group"><label class="label">Status do Pedido</label>
        <select class="select" id="ped-status">
          <option value="pendente">â³ Pendente</option>
          <option value="confirmado">âœ… Confirmado</option>
          <option value="entregue">ğŸ“¦ Entregue</option>
          <option value="cancelado">âŒ Cancelado</option>
        </select>
      </div>
    </div>
    <div class="form-group"><label class="label">CÃ³digo do Afiliado (opcional)</label><input class="input" id="ped-afiliado" placeholder="CÃ³digo de referÃªncia do afiliado"></div>
    <div class="form-group"><label class="label">ObservaÃ§Ãµes</label><textarea class="textarea" id="ped-notas" placeholder="Notas adicionais..."></textarea></div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="closeModal('modal-pedido')">Cancelar</button>
    <button class="btn btn-primary" onclick="savePedido()">ğŸ’¾ Guardar Pedido</button>
  </div>
</div></div>

<!-- Modal Convite Gerado -->
<div class="modal-overlay" id="modal-convite">
<div class="modal" style="max-width:480px">
  <div class="modal-header"><div class="modal-title">ğŸ”— Link de Convite Gerado</div><button class="btn btn-ghost btn-icon" onclick="closeModal('modal-convite')">âœ•</button></div>
  <div class="modal-body">
    <div style="text-align:center;margin-bottom:20px">
      <div style="font-size:48px;margin-bottom:8px" id="conv-icon">ğŸ¤</div>
      <div style="font-size:20px;font-weight:800" id="conv-tipo-label">Convite de Parceiro</div>
    </div>
    <div style="background:var(--bg2);border-radius:var(--radius-md);padding:16px;margin-bottom:16px">
      <div style="font-size:12px;color:var(--text-secondary);margin-bottom:6px">CÃ³digo de Convite</div>
      <div class="invite-code" id="conv-code">HM000000</div>
    </div>
    <div style="background:var(--bg2);border-radius:var(--radius-md);padding:12px;margin-bottom:16px">
      <div style="font-size:12px;color:var(--text-secondary);margin-bottom:6px">Link de Cadastro</div>
      <div style="word-break:break-all;font-size:13px;color:var(--accent)" id="conv-url"></div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-primary" style="flex:1" onclick="copiarConvite()">ğŸ“‹ Copiar Link</button>
      <button class="btn btn-success" style="flex:1" onclick="partilharConvite()">ğŸ“² Partilhar WhatsApp</button>
    </div>
  </div>
</div></div>

<!-- Modal Ver Pedido (detalhes completos) -->
<div class="modal-overlay" id="modal-pedido-detalhes">
<div class="modal" style="max-width:600px">
  <div class="modal-header"><div class="modal-title">ğŸ›’ Detalhes do Pedido</div><button class="btn btn-ghost btn-icon" onclick="closeModal('modal-pedido-detalhes')">âœ•</button></div>
  <div class="modal-body" id="modal-pedido-detalhes-body"></div>
  <div class="modal-footer" id="modal-pedido-detalhes-footer"></div>
</div></div>


<!-- Modal CupÃ£o -->
<div class="modal-overlay" id="modal-cupao">
<div class="modal" style="max-width:520px">
  <div class="modal-header"><div class="modal-title" id="modal-cup-title">Novo CupÃ£o</div><button class="btn btn-ghost btn-icon" onclick="closeModal('modal-cupao')">âœ•</button></div>
  <div class="modal-body">
    <input type="hidden" id="cup-edit-id">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
      <div class="form-group">
        <label class="label">CÃ³digo do CupÃ£o *</label>
        <div style="display:flex;gap:6px">
          <input class="input" id="cup-codigo" placeholder="Ex: HEPO20" style="text-transform:uppercase;flex:1">
          <button class="btn btn-ghost btn-sm" onclick="document.getElementById('cup-codigo').value=gerarCodigo()" title="Gerar cÃ³digo aleatÃ³rio">ğŸ²</button>
        </div>
      </div>
      <div class="form-group">
        <label class="label">Tipo de Desconto *</label>
        <select class="select" id="cup-tipo">
          <option value="percentagem">ğŸ“‰ Percentagem (%)</option>
          <option value="valor">ğŸ’° Valor Fixo (Kz)</option>
        </select>
      </div>
      <div class="form-group">
        <label class="label">Valor do Desconto *</label>
        <input class="input" type="number" id="cup-valor" placeholder="Ex: 20" min="0">
      </div>
      <div class="form-group">
        <label class="label">MÃ¡ximo de Usos (vazio = ilimitado)</label>
        <input class="input" type="number" id="cup-maxusos" placeholder="Ex: 100" min="1">
      </div>
      <div class="form-group">
        <label class="label">VÃ¡lido atÃ©</label>
        <input class="input" type="date" id="cup-validade">
      </div>
      <div class="form-group" style="display:flex;align-items:center;gap:10px;padding-top:24px">
        <input type="checkbox" id="cup-ativo" checked style="width:18px;height:18px;accent-color:var(--accent)">
        <label for="cup-ativo" style="font-weight:600;cursor:pointer">âœ… CupÃ£o Activo</label>
      </div>
    </div>
    <div class="form-group">
      <label class="label">DescriÃ§Ã£o / Nota interna</label>
      <input class="input" id="cup-desc" placeholder="Ex: PromoÃ§Ã£o de boas-vindas para novos clientes">
    </div>
    <div style="background:var(--accent-light);border-radius:10px;padding:12px;font-size:13px;color:var(--accent);font-weight:600">
      ğŸ’¡ O cliente insere o cÃ³digo no carrinho antes de confirmar o pedido.
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="closeModal('modal-cupao')">Cancelar</button>
    <button class="btn btn-primary" onclick="saveCupao()">ğŸ’¾ Guardar CupÃ£o</button>
  </div>
</div>
</div>
<div id="toast-container"></div>

<script src="data.js"></script>
<script>
// ============================================================
// INIT
// ============================================================
Auth.guard();
let cfg = DB.getConfig();

function applyTheme(t) {
  document.documentElement.setAttribute('data-theme', t);
  localStorage.setItem('hm_public_theme', t);
  const btn = document.getElementById('btn-tema');
  if (btn) btn.textContent = t === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
}
function applyAccent(color) {
  document.documentElement.style.setProperty('--accent', color);
  const r=parseInt(color.slice(1,3),16), g=parseInt(color.slice(3,5),16), b=parseInt(color.slice(5,7),16);
  document.documentElement.style.setProperty('--accent-light',`rgba(${r},${g},${b},0.12)`);
  document.documentElement.style.setProperty('--accent-dark',`rgb(${Math.max(0,r-30)},${Math.max(0,g-30)},${Math.max(0,b-30)})`);
}
function applyFundo() {
  const c = DB.getConfig();
  if (c.fundoTipo==='gradiente') { document.body.style.background=`linear-gradient(135deg,${c.fundoCor1||'#e8f0fe'},${c.fundoCor2||'#c2d4f8'})`; document.body.style.backgroundAttachment='fixed'; }
  else if (c.fundoTipo==='cor-solida') { document.body.style.background=c.fundoCor1||'#f3f3f3'; }
  else if (c.fundoTipo==='imagem'&&c.fundoImagem) { document.body.style.background=`url(${c.fundoImagem}) center/cover fixed`; }
  else { document.body.style.background=''; }
}

applyTheme(cfg.tema||'light');
applyAccent(cfg.corAcento||'#0078D4');
applyFundo();

// Topbar init
document.getElementById('topbar-date').textContent = new Date().toLocaleDateString('pt-AO',{weekday:'short',day:'2-digit',month:'short'});
document.getElementById('sidebar-brand').textContent = cfg.nomeEmpresa||'HepoMarket';

function updateTopbarCeo() {
  const c = DB.getConfig();
  const nome = (c.ceoPerfil&&c.ceoPerfil.nome)||Auth.getUtilizador()||'CEO';
  document.getElementById('topbar-ceo-name').textContent = nome.split(' ')[0];
  const av = document.getElementById('topbar-avatar');
  if (c.ceoPerfil&&c.ceoPerfil.foto) {
    av.innerHTML = `<img src="${c.ceoPerfil.foto}" style="width:36px;height:36px;border-radius:50%;object-fit:cover">`;
  } else {
    av.innerHTML = nome[0]||'M';
    av.style.background='var(--accent)'; av.style.color='#fff';
  }
}
updateTopbarCeo();

// ============================================================
// NAVIGATION
// ============================================================
const viewTitles = { home:'Painel Principal', produtos:'ğŸ“¦ Produtos', servicos:'ğŸ› ï¸ ServiÃ§os', pedidos:'ğŸ›’ Pedidos', clientes:'ğŸ‘¥ Clientes', parceiros:'ğŸ¤ Parceiros', aprovacoes:'âœ… AprovaÃ§Ãµes', convites:'ğŸ”— Convites', bancario:'ğŸ¦ Dados BancÃ¡rios', cupoes:'ğŸŸï¸ CupÃµes de Desconto', mensagens:'âœ‰ï¸ Mensagens', perfil:'ğŸ‘¤ Perfil CEO', configuracoes:'âš™ï¸ DefiniÃ§Ãµes' };
let currentView = 'home';

function goView(id, el) {
  currentView = id;
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  const v = document.getElementById('view-'+id); if(v) v.classList.add('active');
  if (el) el.classList.add('active');
  else { const f=document.querySelector(`.nav-item[data-view="${id}"]`); if(f) f.classList.add('active'); }
  document.getElementById('topbar-title').textContent = viewTitles[id]||id;
  document.getElementById('notif-dropdown').classList.remove('open');
  if (id==='home') renderHome();
  else if (id==='produtos') renderProdTable();
  else if (id==='servicos') renderServTable();
  else if (id==='pedidos') renderPedidos();
  else if (id==='clientes') renderClientes();
  else if (id==='parceiros') renderParceiros();
  else if (id==='aprovacoes') renderAprovacoes();
  else if (id==='convites') renderConvites();
  else if (id==='bancario') loadBancario();
  else if (id==='mensagens') renderMensagens();
  else if (id==='cupoes') renderCupoes();
  else if (id==='perfil') loadPerfil();
  else if (id==='configuracoes') loadConfig();
  updateBadges();
}

function refreshView() {
  const btn=document.getElementById('btn-refresh');
  btn.style.transform='rotate(360deg)'; btn.style.transition='transform 0.5s';
  setTimeout(()=>{btn.style.transform='';btn.style.transition='';},500);
  goView(currentView); toast('Actualizado!','success');
}
function verSite() { window.open('index.html','_blank'); }
function logout() { Auth.logout(); window.location.href='login.html'; }

// ============================================================
// BADGES
// ============================================================
function updateBadges() {
  const s = DB.getStats();
  document.getElementById('badge-prod').textContent = s.produtos;
  document.getElementById('badge-serv').textContent = s.servicos;
  document.getElementById('badge-cli').textContent = s.clientes;
  document.getElementById('badge-par').textContent = s.parceiros;
  document.getElementById('badge-ped').textContent = s.pedidosPendentes||0;
  document.getElementById('badge-aprov').textContent = (s.parceirosPendentes||0)+(s.pedidosPendentes||0);
  document.getElementById('badge-msg').textContent = s.mensagensNaoLidas;
  document.getElementById('badge-conv').textContent = s.convites;
  const bcup=document.getElementById('badge-cup'); if(bcup) bcup.textContent=Cupoes.getAll().filter(c=>c.ativo).length;
  const nb = s.notificacoesNaoLidas;
  const nbEl = document.getElementById('notif-badge');
  nbEl.style.display = nb>0?'flex':'none'; nbEl.textContent = nb>99?'99+':nb;
  const mb = s.mensagensNaoLidas;
  const mbEl = document.getElementById('msg-badge');
  mbEl.style.display = mb>0?'flex':'none'; mbEl.textContent = mb;
}

// ============================================================
// TOAST
// ============================================================
function toast(msg,type='info') {
  const el=document.createElement('div'); el.className=`toast toast-${type}`;
  el.innerHTML=(type==='success'?'âœ… ':type==='error'?'âŒ ':'â„¹ï¸ ')+msg;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(()=>el.remove(),3500);
}

// ============================================================
// MODAL
// ============================================================
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(o=>{ o.addEventListener('click',e=>{if(e.target===o)closeModal(o.id);}); });

// ============================================================
// NOTIFICAÃ‡Ã•ES
// ============================================================
function toggleNotif() { const dd=document.getElementById('notif-dropdown'); dd.classList.toggle('open'); if(dd.classList.contains('open'))renderNotifDropdown(); }
function renderNotifDropdown() {
  const notifs=DB.getNotificacoes();
  const icons={parceiro:'ğŸ¤',pedido:'ğŸ›’',mensagem:'âœ‰ï¸',cliente:'ğŸ‘¤',sistema:'âš™ï¸'};
  const list=document.getElementById('notif-list');
  if(!notifs.length){list.innerHTML=`<div style="padding:24px;text-align:center;color:var(--text-secondary)">Sem notificaÃ§Ãµes</div>`;return;}
  list.innerHTML=notifs.slice(0,15).map(n=>`<div class="notif-item ${n.lida?'':'unread'}" onclick="clicNotif('${n.id}','${n.link||'home'}')"><div class="notif-title">${icons[n.tipo]||'ğŸ””'} ${n.titulo}</div><div class="notif-body">${n.mensagem}</div><div class="notif-time">${formatarDataRelativa(n.criadoEm)}</div></div>`).join('');
  updateBadges();
}
function clicNotif(id,link) { DB.marcarNotificacaoLida(id); document.getElementById('notif-dropdown').classList.remove('open'); if(link&&viewTitles[link])goView(link); updateBadges(); }
document.addEventListener('click',e=>{ if(!e.target.closest('.notif-wrap'))document.getElementById('notif-dropdown').classList.remove('open'); });

// ============================================================
// HOME
// ============================================================
let chartCat,chartPar,chartMonthly;
function renderHome() {
  const s=DB.getStats(); const prods=DB.getProdutos(); const parceiros=DB.getParceiros();
  document.getElementById('home-welcome').textContent=`Bem-vindo, ${(cfg.ceoPerfil&&cfg.ceoPerfil.nome)||Auth.getUtilizador()||'CEO'} ğŸ‘‹`;
  document.getElementById('home-subtitle').textContent='Resumo â€” '+new Date().toLocaleDateString('pt-AO');

  document.getElementById('stat-grid').innerHTML=`
    <div class="stat-card stat-accent"><div class="stat-icon">ğŸ“¦</div><div class="stat-value">${s.produtos}</div><div class="stat-label">Produtos</div></div>
    <div class="stat-card stat-green"><div class="stat-icon">ğŸ‘¥</div><div class="stat-value">${s.clientes}</div><div class="stat-label">Clientes</div></div>
    <div class="stat-card stat-orange"><div class="stat-icon">ğŸ¤</div><div class="stat-value">${s.parceiros}</div><div class="stat-label">Parceiros</div></div>
    <div class="stat-card stat-purple"><div class="stat-icon">ğŸ›’</div><div class="stat-value">${s.pedidosTotal}</div><div class="stat-label">Pedidos Total</div></div>
    <div class="stat-card" style="border-top:3px solid #107c10"><div class="stat-icon">âœ…</div><div class="stat-value">${s.parceirosAtivos}</div><div class="stat-label">Parceiros Activos</div></div>
    <div class="stat-card" style="border-top:3px solid #d47f00"><div class="stat-icon">â³</div><div class="stat-value">${s.pedidosPendentes||0}</div><div class="stat-label">Pedidos Pendentes</div></div>
    <div class="stat-card" style="border-top:3px solid #c42b1c"><div class="stat-icon">ğŸ’¬</div><div class="stat-value">${s.mensagensNaoLidas}</div><div class="stat-label">Msgs NÃ£o Lidas</div></div>
    <div class="stat-card" style="border-top:3px solid #8764b8"><div class="stat-icon">ğŸ’°</div><div class="stat-value" style="font-size:18px">${formatarKz(s.receitaTotal)}</div><div class="stat-label">Receita Total</div></div>`;

  // Charts
  const cats={};
  prods.forEach(p=>{ const c=p.categoria||'Sem Categoria'; cats[c]=(cats[c]||0)+1; });
  const ctxCat=document.getElementById('chart-cat').getContext('2d');
  if(chartCat)chartCat.destroy();
  chartCat=new Chart(ctxCat,{type:'doughnut',data:{labels:Object.keys(cats),datasets:[{data:Object.values(cats),backgroundColor:['#0078D4','#107c10','#d47f00','#c42b1c','#8764b8','#038387']}]},options:{plugins:{legend:{position:'bottom'}}}});

  const statuses={ativo:0,pendente:0,rejeitado:0};
  parceiros.forEach(p=>{statuses[p.status]=(statuses[p.status]||0)+1;});
  const ctxPar=document.getElementById('chart-par').getContext('2d');
  if(chartPar)chartPar.destroy();
  chartPar=new Chart(ctxPar,{type:'pie',data:{labels:['Activos','Pendentes','Rejeitados'],datasets:[{data:[statuses.ativo,statuses.pendente,statuses.rejeitado],backgroundColor:['#107c10','#d47f00','#c42b1c']}]},options:{plugins:{legend:{position:'bottom'}}}});

  // Pedidos por mÃªs
  const pedidos=DB.getPedidos();
  const months=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
  const mCounts=new Array(12).fill(0);
  pedidos.forEach(p=>{const m=new Date(p.criadoEm).getMonth();mCounts[m]++;});
  const ctxM=document.getElementById('chart-monthly').getContext('2d');
  if(chartMonthly)chartMonthly.destroy();
  chartMonthly=new Chart(ctxM,{type:'bar',data:{labels:months,datasets:[{label:'Pedidos',data:mCounts,backgroundColor:'rgba(0,120,212,0.7)',borderRadius:6}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}}});

  // Ãšltimos pedidos
  document.getElementById('recent-pedidos').innerHTML=pedidos.slice(0,5).map(p=>`
    <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)">
      <div><div style="font-weight:600;font-size:13px">${p.produto||'â€”'}</div><div style="font-size:12px;color:var(--text-secondary)">${p.nomeCliente||'â€”'} Â· ${formatarDataRelativa(p.criadoEm)}</div></div>
      <span class="status-pill" style="${statusColor(p.status)}">${statusLabel(p.status)}</span>
    </div>`).join('')||'<div style="color:var(--text-secondary);padding:8px 0">Nenhum pedido ainda</div>';

  // Ãšltimos parceiros
  document.getElementById('recent-pars').innerHTML=parceiros.slice(0,5).map(p=>`
    <div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)">
      <div class="avatar" style="width:32px;height:32px;font-size:13px;flex-shrink:0">${p.foto?`<img src="${p.foto}" style="width:32px;height:32px;border-radius:50%;object-fit:cover">`:p.nome[0]}</div>
      <div style="flex:1"><div style="font-weight:600;font-size:13px">${p.nome}</div><div style="font-size:12px;color:var(--text-secondary)">${formatarDataRelativa(p.criadoEm)}</div></div>
      <span class="status-pill" style="${statusColor(p.status)}">${statusLabel(p.status)}</span>
    </div>`).join('')||'<div style="color:var(--text-secondary);padding:8px 0">Nenhum parceiro ainda</div>';
}

function statusColor(s) {
  if(s==='ativo'||s==='confirmado'||s==='entregue') return 'background:rgba(16,124,16,0.12);color:#107c10';
  if(s==='pendente') return 'background:rgba(212,127,0,0.12);color:#d47f00';
  return 'background:rgba(196,43,28,0.12);color:#c42b1c';
}
function statusLabel(s) {
  const map={ativo:'âœ… Activo',pendente:'â³ Pendente',rejeitado:'âŒ Rejeitado',confirmado:'âœ… Confirmado',entregue:'ğŸ“¦ Entregue',cancelado:'âŒ Cancelado',inativo:'â›” Inactivo'};
  return map[s]||s;
}

// ============================================================
// PRODUTOS
// ============================================================
function renderProdTable() {
  const q=document.getElementById('prod-search').value.toLowerCase();
  const cat=document.getElementById('prod-filter-cat').value;
  let prods=DB.getProdutos();
  const cats=[...new Set(prods.map(p=>p.categoria).filter(Boolean))];
  const cl=document.getElementById('cat-list'); if(cl) cl.innerHTML=cats.map(c=>`<option>${c}</option>`).join('');
  const fc=document.getElementById('prod-filter-cat'); if(fc){ const cur=fc.value; fc.innerHTML='<option value="">Todas as categorias</option>'+cats.map(c=>`<option ${c===cur?'selected':''}>${c}</option>`).join(''); }
  if(q) prods=prods.filter(p=>(p.nome||'').toLowerCase().includes(q)||(p.categoria||'').toLowerCase().includes(q));
  if(cat) prods=prods.filter(p=>p.categoria===cat);
  document.getElementById('prod-tbody').innerHTML=prods.map(p=>`
    <tr>
      <td>${p.imagem?`<img src="${p.imagem}" style="width:48px;height:48px;border-radius:8px;object-fit:cover">`:
        `<div style="width:48px;height:48px;border-radius:8px;background:var(--accent-light);display:flex;align-items:center;justify-content:center;font-size:24px">ğŸ“¦</div>`}</td>
      <td><div style="font-weight:600">${p.nome||'â€”'}</div><div style="font-size:12px;color:var(--text-secondary)">${(p.descricao||'').substring(0,60)}</div></td>
      <td><span class="badge badge-blue">${p.categoria||'â€”'}</span></td>
      <td style="font-weight:700">${formatarKz(p.preco)}</td>
      <td>${p.stock||'âˆ'}</td>
      <td>${formatarData(p.criadoEm)}</td>
      <td><div style="display:flex;gap:4px"><button class="btn btn-ghost btn-sm" onclick="editProd('${p.id}')">âœï¸</button><button class="btn btn-danger btn-sm" onclick="removeProd('${p.id}')">ğŸ—‘ï¸</button></div></td>
    </tr>`).join('')||`<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-secondary)">Nenhum produto ainda. Clique em â• para adicionar.</td></tr>`;
}

let prodImgData='';
function loadProdImg(e) {
  const f=e.target.files[0]; if(!f)return;
  imageParaBase64(f).then(b64=>{ prodImgData=b64; document.getElementById('prod-img-preview').src=b64; document.getElementById('prod-img-preview').style.display='block'; document.getElementById('prod-img-text').style.display='none'; document.getElementById('prod-img-clear').style.display='inline-flex'; });
}
function clearProdImg() { prodImgData=''; document.getElementById('prod-img-preview').style.display='none'; document.getElementById('prod-img-text').style.display='flex'; document.getElementById('prod-img-clear').style.display='none'; document.getElementById('prod-img-file').value=''; }

function openProdModal(p) {
  prodImgData=''; clearProdImg();
  document.getElementById('prod-edit-id').value='';
  document.getElementById('prod-nome').value=''; document.getElementById('prod-cat').value='';
  document.getElementById('prod-preco').value=''; document.getElementById('prod-stock').value=''; document.getElementById('prod-desc').value='';
  document.getElementById('modal-prod-title').textContent='Adicionar Produto';
  if(p){ document.getElementById('modal-prod-title').textContent='Editar Produto'; document.getElementById('prod-edit-id').value=p.id; document.getElementById('prod-nome').value=p.nome||''; document.getElementById('prod-cat').value=p.categoria||''; document.getElementById('prod-preco').value=p.preco||''; document.getElementById('prod-stock').value=p.stock||''; document.getElementById('prod-desc').value=p.descricao||''; if(p.imagem){prodImgData=p.imagem;document.getElementById('prod-img-preview').src=p.imagem;document.getElementById('prod-img-preview').style.display='block';document.getElementById('prod-img-text').style.display='none';document.getElementById('prod-img-clear').style.display='inline-flex';} }
  openModal('modal-prod');
}
function editProd(id) { const p=DB.getProdutos().find(x=>x.id===id); if(p)openProdModal(p); }
function saveProd() {
  const nome=document.getElementById('prod-nome').value.trim(); if(!nome){toast('Nome obrigatÃ³rio','error');return;}
  const id=document.getElementById('prod-edit-id').value;
  const data={nome,categoria:document.getElementById('prod-cat').value,preco:document.getElementById('prod-preco').value,stock:document.getElementById('prod-stock').value,descricao:document.getElementById('prod-desc').value,imagem:prodImgData||''};
  if(id) DB.updateProduto(id,data); else DB.addProduto(data);
  closeModal('modal-prod'); renderProdTable(); updateBadges(); toast('Produto guardado!','success');
}
function removeProd(id) { if(confirm('Remover produto?')){DB.removeProduto(id);renderProdTable();updateBadges();toast('Produto removido','info');} }

// ============================================================
// SERVIÃ‡OS
// ============================================================
function renderServTable() {
  const servs=DB.getServicos();
  document.getElementById('serv-tbody').innerHTML=servs.map(s=>`
    <tr>
      <td style="font-size:28px">${s.icone||'ğŸ› ï¸'}</td>
      <td><div style="font-weight:600">${s.nome||'â€”'}</div></td>
      <td style="color:var(--text-secondary);max-width:200px">${(s.descricao||'').substring(0,80)}</td>
      <td style="font-weight:700">${formatarKz(s.preco)}</td>
      <td>${formatarData(s.criadoEm)}</td>
      <td><div style="display:flex;gap:4px"><button class="btn btn-ghost btn-sm" onclick="editServ('${s.id}')">âœï¸</button><button class="btn btn-danger btn-sm" onclick="removeServ('${s.id}')">ğŸ—‘ï¸</button></div></td>
    </tr>`).join('')||`<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--text-secondary)">Nenhum serviÃ§o ainda.</td></tr>`;
}
function openServModal(s) {
  document.getElementById('serv-edit-id').value=''; document.getElementById('serv-nome').value=''; document.getElementById('serv-icon').value=''; document.getElementById('serv-preco').value=''; document.getElementById('serv-desc').value='';
  document.getElementById('modal-serv-title').textContent='Adicionar ServiÃ§o';
  if(s){ document.getElementById('modal-serv-title').textContent='Editar ServiÃ§o'; document.getElementById('serv-edit-id').value=s.id; document.getElementById('serv-nome').value=s.nome||''; document.getElementById('serv-icon').value=s.icone||''; document.getElementById('serv-preco').value=s.preco||''; document.getElementById('serv-desc').value=s.descricao||''; }
  openModal('modal-serv');
}
function editServ(id) { const s=DB.getServicos().find(x=>x.id===id); if(s)openServModal(s); }
function saveServ() {
  const nome=document.getElementById('serv-nome').value.trim(); if(!nome){toast('Nome obrigatÃ³rio','error');return;}
  const id=document.getElementById('serv-edit-id').value;
  const data={nome,icone:document.getElementById('serv-icon').value||'ğŸ› ï¸',preco:document.getElementById('serv-preco').value,descricao:document.getElementById('serv-desc').value};
  if(id) DB.updateServico(id,data); else DB.addServico(data);
  closeModal('modal-serv'); renderServTable(); updateBadges(); toast('ServiÃ§o guardado!','success');
}
function removeServ(id) { if(confirm('Remover serviÃ§o?')){DB.removeServico(id);renderServTable();updateBadges();toast('ServiÃ§o removido','info');} }

// ============================================================
// PEDIDOS
// ============================================================
function renderPedidos() {
  const q=document.getElementById('ped-search').value.toLowerCase();
  const filter=document.getElementById('ped-filter').value;
  let pedidos=DB.getPedidos().sort((a,b)=>new Date(b.criadoEm)-new Date(a.criadoEm));
  if(q) pedidos=pedidos.filter(p=>(p.produto||'').toLowerCase().includes(q)||(p.nomeCliente||'').toLowerCase().includes(q)||(p.numero||'').toLowerCase().includes(q));
  if(filter) pedidos=pedidos.filter(p=>p.status===filter);
  document.getElementById('pedidos-list').innerHTML=pedidos.map(p=>`
    <div class="card-solid" style="padding:16px;margin-bottom:12px;border-left:4px solid ${p.status==='pendente'?'#d47f00':p.status==='confirmado'?'#0078D4':p.status==='entregue'?'#107c10':'#c42b1c'}">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">
        <div>
          <div style="display:flex;align-items:center;gap:8px">
            <span style="font-weight:800;font-size:15px">${p.produto||'â€”'}</span>
            <span class="badge" style="font-size:11px;background:var(--bg2);color:var(--text-secondary)">${p.numero||''}</span>
          </div>
          <div style="color:var(--text-secondary);font-size:13px;margin-top:2px">ğŸ‘¤ ${p.nomeCliente||'â€”'} Â· ğŸ“ ${p.telCliente||'â€”'} Â· ${formatarDataRelativa(p.criadoEm)}</div>
          ${p.provincia||p.endereco?`<div style="font-size:12px;color:var(--text-secondary);margin-top:2px">ğŸ“ ${[p.provincia,p.municipio,p.endereco].filter(Boolean).join(', ')}</div>`:''}
        </div>
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
          <span style="font-weight:800;font-size:16px;color:var(--accent)">${formatarKz(p.total||p.valor||0)}</span>
          <span class="status-pill" style="${statusColor(p.status)}">${statusLabel(p.status)}</span>
          <button class="btn btn-ghost btn-sm" onclick="verPedidoDetalhes('${p.id}')">ğŸ‘ï¸</button>
          <button class="btn btn-ghost btn-sm" onclick="editPedidoModal('${p.id}')">âœï¸</button>
          ${p.status==='pendente'?`<button class="btn btn-success btn-sm" onclick="confirmarPedido('${p.id}')">âœ…</button>`:
            p.status==='confirmado'?`<button class="btn btn-primary btn-sm" onclick="entregarPedido('${p.id}')">ğŸ“¦</button>`:''}
          <button class="btn btn-danger btn-sm" onclick="removePedidoItem('${p.id}')">ğŸ—‘ï¸</button>
        </div>
      </div>
    </div>`).join('')||`<div class="empty-state"><div class="empty-state-icon">ğŸ›’</div><div class="empty-state-title">Nenhum pedido</div></div>`;
}

function openPedidoModal() {
  document.getElementById('pedido-edit-id').value='';
  ['ped-produto','ped-valor','ped-qtd','ped-nome-cliente','ped-tel-cliente','ped-email-cliente','ped-municipio','ped-endereco','ped-referencia','ped-afiliado','ped-notas'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  document.getElementById('ped-qtd').value='1';
  document.getElementById('ped-provincia').value='';
  document.getElementById('ped-pagamento').value='';
  document.getElementById('ped-status').value='pendente';
  document.getElementById('modal-pedido-title').textContent='Registar Pedido';
  openModal('modal-pedido');
}
function editPedidoModal(id) {
  const p=DB.getPedidos().find(x=>x.id===id); if(!p)return;
  document.getElementById('pedido-edit-id').value=p.id;
  document.getElementById('ped-produto').value=p.produto||'';
  document.getElementById('ped-valor').value=p.total||p.valor||'';
  document.getElementById('ped-qtd').value=p.qtd||1;
  document.getElementById('ped-nome-cliente').value=p.nomeCliente||'';
  document.getElementById('ped-tel-cliente').value=p.telCliente||'';
  document.getElementById('ped-email-cliente').value=p.emailCliente||'';
  document.getElementById('ped-provincia').value=p.provincia||'';
  document.getElementById('ped-municipio').value=p.municipio||'';
  document.getElementById('ped-endereco').value=p.endereco||'';
  document.getElementById('ped-referencia').value=p.referencia||'';
  document.getElementById('ped-pagamento').value=p.metodoPagamento||'';
  document.getElementById('ped-status').value=p.status||'pendente';
  document.getElementById('ped-afiliado').value=p.codigoAfiliado||'';
  document.getElementById('ped-notas').value=p.notas||'';
  document.getElementById('modal-pedido-title').textContent='Editar Pedido';
  openModal('modal-pedido');
}
function savePedido() {
  const produto=document.getElementById('ped-produto').value.trim(); if(!produto){toast('Produto obrigatÃ³rio','error');return;}
  const nomeCliente=document.getElementById('ped-nome-cliente').value.trim(); if(!nomeCliente){toast('Nome do cliente obrigatÃ³rio','error');return;}
  const id=document.getElementById('pedido-edit-id').value;
  const data={produto, qtd:document.getElementById('ped-qtd').value||1, total:document.getElementById('ped-valor').value,
    nomeCliente, telCliente:document.getElementById('ped-tel-cliente').value,
    emailCliente:document.getElementById('ped-email-cliente').value,
    provincia:document.getElementById('ped-provincia').value,
    municipio:document.getElementById('ped-municipio').value,
    endereco:document.getElementById('ped-endereco').value,
    referencia:document.getElementById('ped-referencia').value,
    metodoPagamento:document.getElementById('ped-pagamento').value,
    status:document.getElementById('ped-status').value,
    codigoAfiliado:document.getElementById('ped-afiliado').value,
    notas:document.getElementById('ped-notas').value};
  if(id) DB.updatePedido(id,data); else DB.addPedido(data);
  closeModal('modal-pedido'); renderPedidos(); updateBadges(); toast('Pedido guardado!','success');
}
function confirmarPedido(id) { DB.aprovarPedido(id); renderPedidos(); updateBadges(); toast('Pedido confirmado!','success'); }
function entregarPedido(id) { DB.entregarPedido(id); renderPedidos(); updateBadges(); toast('Pedido marcado como entregue!','success'); }
function removePedidoItem(id) { if(confirm('Remover pedido?')){DB.removePedido(id);renderPedidos();updateBadges();toast('Pedido removido','info');} }

function verPedidoDetalhes(id) {
  const p=DB.getPedidos().find(x=>x.id===id); if(!p)return;
  const cfg2=DB.getConfig();
  document.getElementById('modal-pedido-detalhes-body').innerHTML=`
    <div style="background:var(--bg2);border-radius:var(--radius-md);padding:12px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center">
      <span style="font-weight:800;font-size:16px">${p.produto||'â€”'}</span>
      <span class="status-pill" style="${statusColor(p.status)}">${statusLabel(p.status)}</span>
    </div>
    <div style="font-weight:700;color:var(--accent);margin-bottom:8px">ğŸ“‹ NÃºmero: ${p.numero||p.id}</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
      <div><div style="font-size:11px;color:var(--text-secondary);font-weight:700;text-transform:uppercase">CLIENTE</div><div style="font-weight:600">${p.nomeCliente||'â€”'}</div></div>
      <div><div style="font-size:11px;color:var(--text-secondary);font-weight:700;text-transform:uppercase">TELEFONE</div><div style="font-weight:600">${p.telCliente||'â€”'}</div></div>
      <div><div style="font-size:11px;color:var(--text-secondary);font-weight:700;text-transform:uppercase">EMAIL</div><div>${p.emailCliente||'â€”'}</div></div>
      <div><div style="font-size:11px;color:var(--text-secondary);font-weight:700;text-transform:uppercase">QUANTIDADE</div><div>${p.qtd||1}</div></div>
    </div>
    <hr class="divider">
    <div style="font-weight:700;margin-bottom:8px">ğŸ“ EndereÃ§o de Entrega</div>
    <div style="background:var(--bg2);border-radius:var(--radius-md);padding:12px;margin-bottom:12px">
      <div>${[p.provincia,p.municipio].filter(Boolean).join(', ')||'â€”'}</div>
      <div style="margin-top:4px">${p.endereco||'â€”'}</div>
      ${p.referencia?`<div style="color:var(--text-secondary);margin-top:4px;font-size:13px">Ref: ${p.referencia}</div>`:''}
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
      <div><div style="font-size:11px;color:var(--text-secondary);font-weight:700;text-transform:uppercase">VALOR TOTAL</div><div style="font-weight:800;font-size:18px;color:var(--accent)">${formatarKz(p.total||p.valor||0)}</div></div>
      <div><div style="font-size:11px;color:var(--text-secondary);font-weight:700;text-transform:uppercase">PAGAMENTO</div><div>${p.metodoPagamento||'â€”'}</div></div>
    </div>
    ${p.codigoAfiliado?`<div><b>Afiliado:</b> ${p.codigoAfiliado}</div>`:''}
    ${p.notas?`<div style="margin-top:8px;padding:10px;background:var(--bg2);border-radius:8px;font-size:13px">ğŸ“ ${p.notas}</div>`:''}
    <div style="font-size:12px;color:var(--text-secondary);margin-top:12px">ğŸ“… Criado: ${formatarData(p.criadoEm)}</div>`;
  const footer=document.getElementById('modal-pedido-detalhes-footer');
  const wa=cfg2.whatsapp||'244952100356';
  const msg=encodeURIComponent(`OlÃ¡ ${p.nomeCliente}, o seu pedido *${p.numero}* â€” *${p.produto}* foi recebido. Aguarde confirmaÃ§Ã£o. HepoMarket`);
  footer.innerHTML=`<button class="btn btn-secondary" onclick="closeModal('modal-pedido-detalhes')">Fechar</button><a href="https://wa.me/${wa}?text=${msg}" target="_blank" class="btn btn-success">ğŸ“² Contactar Cliente</a>`;
  openModal('modal-pedido-detalhes');
}

// ============================================================
// CLIENTES
// ============================================================
let cliAvatarData='';
function loadCliAvatar(e) { const f=e.target.files[0]; if(!f)return; imageParaBase64(f).then(b64=>{cliAvatarData=b64; const el=document.getElementById('cli-avatar-preview'); el.innerHTML=`<img src="${b64}" style="width:72px;height:72px;border-radius:50%;object-fit:cover">`; }); }
function renderClientes() {
  const q=(document.getElementById('cli-search').value||'').toLowerCase();
  let clientes=DB.getClientes();
  if(q) clientes=clientes.filter(c=>(c.nome||'').toLowerCase().includes(q)||(c.tel||'').includes(q));
  document.getElementById('cli-grid').innerHTML=clientes.map(c=>`
    <div class="profile-card" style="position:relative">
      <div class="avatar avatar-lg">${c.foto?`<img src="${c.foto}" style="width:72px;height:72px;border-radius:50%;object-fit:cover">`:c.nome[0]}</div>
      <div style="font-weight:700">${c.nome||'â€”'}</div>
      <div style="font-size:12px;color:var(--text-secondary)">${c.tel||'â€”'}</div>
      ${c.provincia||c.municipio?`<div style="font-size:11px;color:var(--accent)">ğŸ“ ${[c.provincia,c.municipio].filter(Boolean).join(', ')}</div>`:''}
      ${c.endereco?`<div style="font-size:11px;color:var(--text-secondary)">${c.endereco.substring(0,40)}</div>`:''}
      <div style="display:flex;gap:6px;margin-top:8px">
        <button class="btn btn-ghost btn-sm" onclick="editCli('${c.id}')">âœï¸</button>
        ${c.tel?`<a href="https://wa.me/244${c.tel.replace(/\D/g,'')}" target="_blank" class="btn btn-success btn-sm">ğŸ“²</a>`:''}
        <button class="btn btn-danger btn-sm" onclick="removeCli('${c.id}')">ğŸ—‘ï¸</button>
      </div>
    </div>`).join('')||`<div class="empty-state" style="grid-column:1/-1"><div class="empty-state-icon">ğŸ‘¥</div><div class="empty-state-title">Nenhum cliente</div></div>`;
}
function openCliModal(c) {
  cliAvatarData='';
  document.getElementById('cli-edit-id').value=''; document.getElementById('cli-foto').value='';
  document.getElementById('cli-avatar-preview').innerHTML='ğŸ‘¤';
  ['cli-nome','cli-tel','cli-email','cli-prov','cli-municipio','cli-endereco','cli-interesse','cli-notas'].forEach(id=>{document.getElementById(id).value='';});
  document.getElementById('modal-cli-title').textContent='Adicionar Cliente';
  if(c){ document.getElementById('modal-cli-title').textContent='Editar Cliente'; document.getElementById('cli-edit-id').value=c.id; document.getElementById('cli-nome').value=c.nome||''; document.getElementById('cli-tel').value=c.tel||''; document.getElementById('cli-email').value=c.email||''; document.getElementById('cli-prov').value=c.provincia||c.prov||''; document.getElementById('cli-municipio').value=c.municipio||''; document.getElementById('cli-endereco').value=c.endereco||''; document.getElementById('cli-interesse').value=c.interesse||''; document.getElementById('cli-notas').value=c.notas||''; if(c.foto){cliAvatarData=c.foto;document.getElementById('cli-avatar-preview').innerHTML=`<img src="${c.foto}" style="width:72px;height:72px;border-radius:50%;object-fit:cover">`;} }
  openModal('modal-cli');
}
function editCli(id) { const c=DB.getClientes().find(x=>x.id===id); if(c)openCliModal(c); }
function saveCli() {
  const nome=document.getElementById('cli-nome').value.trim(); if(!nome){toast('Nome obrigatÃ³rio','error');return;}
  const id=document.getElementById('cli-edit-id').value;
  const data={nome, tel:document.getElementById('cli-tel').value, email:document.getElementById('cli-email').value, provincia:document.getElementById('cli-prov').value, municipio:document.getElementById('cli-municipio').value, endereco:document.getElementById('cli-endereco').value, interesse:document.getElementById('cli-interesse').value, notas:document.getElementById('cli-notas').value, foto:cliAvatarData||''};
  if(id) DB.updateCliente(id,data); else DB.addCliente(data);
  closeModal('modal-cli'); renderClientes(); updateBadges(); toast('Cliente guardado!','success');
}
function removeCli(id) { if(confirm('Remover cliente?')){DB.removeCliente(id);renderClientes();updateBadges();toast('Cliente removido','info');} }

// ============================================================
// PARCEIROS
// ============================================================
let parAvatarData='';
function loadParAvatar(e) { const f=e.target.files[0]; if(!f)return; imageParaBase64(f).then(b64=>{parAvatarData=b64; const el=document.getElementById('par-avatar-preview'); el.innerHTML=`<img src="${b64}" style="width:72px;height:72px;border-radius:50%;object-fit:cover">`; }); }
function renderParceiros() {
  const q=(document.getElementById('par-search').value||'').toLowerCase();
  const filter=document.getElementById('par-filter').value;
  let pars=DB.getParceiros();
  if(q) pars=pars.filter(p=>(p.nome||'').toLowerCase().includes(q)||(p.tel||'').includes(q));
  if(filter) pars=pars.filter(p=>p.status===filter);
  document.getElementById('par-grid').innerHTML=pars.map(p=>`
    <div class="profile-card">
      <div class="avatar avatar-lg">${p.foto?`<img src="${p.foto}" style="width:72px;height:72px;border-radius:50%;object-fit:cover">`:p.nome[0]}</div>
      <div style="font-weight:700">${p.nome||'â€”'}</div>
      <div style="font-size:12px;color:var(--text-secondary)">${p.tel||'â€”'}</div>
      <span class="status-pill" style="${statusColor(p.status)}">${statusLabel(p.status)}</span>
      ${p.comissao?`<div style="font-size:12px;color:var(--accent)">ğŸ’° ${p.comissao}% comissÃ£o</div>`:''}
      <div style="display:flex;gap:6px;margin-top:8px">
        <button class="btn btn-ghost btn-sm" onclick="editPar('${p.id}')">âœï¸</button>
        ${p.status==='pendente'?`<button class="btn btn-success btn-sm" onclick="aprovarPar('${p.id}')">âœ…</button>`:''}
        ${p.tel?`<a href="https://wa.me/244${p.tel.replace(/\D/g,'')}" target="_blank" class="btn btn-success btn-sm">ğŸ“²</a>`:''}
        <button class="btn btn-danger btn-sm" onclick="removePar('${p.id}')">ğŸ—‘ï¸</button>
      </div>
    </div>`).join('')||`<div class="empty-state" style="grid-column:1/-1"><div class="empty-state-icon">ğŸ¤</div><div class="empty-state-title">Nenhum parceiro</div></div>`;
}
function openParModal(p) {
  parAvatarData='';
  document.getElementById('par-edit-id').value=''; document.getElementById('par-foto').value='';
  document.getElementById('par-avatar-preview').innerHTML='ğŸ‘¤';
  ['par-nome','par-tel','par-email','par-prov','par-notas'].forEach(id=>{document.getElementById(id).value='';});
  document.getElementById('par-comissao').value=''; document.getElementById('par-status').value='pendente';
  document.getElementById('modal-par-title').textContent='Adicionar Parceiro';
  if(p){ document.getElementById('modal-par-title').textContent='Editar Parceiro'; document.getElementById('par-edit-id').value=p.id; document.getElementById('par-nome').value=p.nome||''; document.getElementById('par-tel').value=p.tel||''; document.getElementById('par-email').value=p.email||''; document.getElementById('par-prov').value=p.provincia||p.prov||''; document.getElementById('par-comissao').value=p.comissao||''; document.getElementById('par-status').value=p.status||'pendente'; document.getElementById('par-notas').value=p.notas||''; if(p.foto){parAvatarData=p.foto;document.getElementById('par-avatar-preview').innerHTML=`<img src="${p.foto}" style="width:72px;height:72px;border-radius:50%;object-fit:cover">`;} }
  openModal('modal-par');
}
function editPar(id) { const p=DB.getParceiros().find(x=>x.id===id); if(p)openParModal(p); }
function savePar() {
  const nome=document.getElementById('par-nome').value.trim(); if(!nome){toast('Nome obrigatÃ³rio','error');return;}
  const id=document.getElementById('par-edit-id').value;
  const data={nome, tel:document.getElementById('par-tel').value, email:document.getElementById('par-email').value, provincia:document.getElementById('par-prov').value, comissao:document.getElementById('par-comissao').value, status:document.getElementById('par-status').value, notas:document.getElementById('par-notas').value, foto:parAvatarData||''};
  if(id) DB.updateParceiro(id,data); else DB.addParceiro(data);
  closeModal('modal-par'); renderParceiros(); updateBadges(); toast('Parceiro guardado!','success');
}
function aprovarPar(id) { DB.aprovarParceiro(id); renderParceiros(); updateBadges(); toast('Parceiro aprovado!','success'); }
function removePar(id) { if(confirm('Remover parceiro?')){DB.removeParceiro(id);renderParceiros();updateBadges();toast('Parceiro removido','info');} }

// ============================================================
// APROVAÃ‡Ã•ES
// ============================================================
function renderAprovacoes() {
  const pendPar=DB.getParceiros().filter(p=>p.status==='pendente');
  const pendPed=DB.getPedidos().filter(p=>p.status==='pendente');

  document.getElementById('aprovacoes-parceiros').innerHTML=pendPar.length?pendPar.map(p=>`
    <div class="approval-card" style="border-left:4px solid #d47f00;margin-bottom:10px">
      <div class="avatar" style="width:48px;height:48px;font-size:20px;flex-shrink:0;background:var(--accent-light);color:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center">${p.foto?`<img src="${p.foto}" style="width:48px;height:48px;border-radius:50%;object-fit:cover">`:p.nome[0]}</div>
      <div style="flex:1"><div style="font-weight:700">${p.nome}</div><div style="font-size:13px;color:var(--text-secondary)">ğŸ“ ${p.tel||'â€”'} Â· ${p.provincia||'â€”'}</div><div style="font-size:12px;color:var(--text-disabled)">${formatarDataRelativa(p.criadoEm)}</div></div>
      <div style="display:flex;gap:6px"><button class="btn btn-success btn-sm" onclick="aprovarParAprov('${p.id}')">âœ… Aprovar</button><button class="btn btn-danger btn-sm" onclick="rejeitarParAprov('${p.id}')">âŒ Rejeitar</button></div>
    </div>`).join(''):`<div style="color:var(--text-secondary);padding:20px;text-align:center">âœ… Nenhum parceiro pendente</div>`;

  document.getElementById('aprovacoes-pedidos').innerHTML=pendPed.length?pendPed.map(p=>`
    <div class="approval-card" style="border-left:4px solid #0078D4;margin-bottom:10px">
      <div style="font-size:28px">ğŸ›’</div>
      <div style="flex:1"><div style="font-weight:700">${p.produto||'â€”'}</div><div style="font-size:13px;color:var(--text-secondary)">ğŸ‘¤ ${p.nomeCliente||'â€”'} Â· ${formatarKz(p.total||p.valor||0)}</div><div style="font-size:12px;color:var(--text-disabled)">${formatarDataRelativa(p.criadoEm)}</div></div>
      <div style="display:flex;gap:6px"><button class="btn btn-success btn-sm" onclick="confirmarPedidoAprov('${p.id}')">âœ… Confirmar</button><button class="btn btn-danger btn-sm" onclick="rejeitarPedidoAprov('${p.id}')">âŒ Cancelar</button></div>
    </div>`).join(''):`<div style="color:var(--text-secondary);padding:20px;text-align:center">âœ… Nenhum pedido pendente</div>`;
}
function aprovarParAprov(id) { DB.aprovarParceiro(id); renderAprovacoes(); updateBadges(); toast('Parceiro aprovado!','success'); }
function rejeitarParAprov(id) { DB.rejeitarParceiro(id); renderAprovacoes(); updateBadges(); toast('Parceiro rejeitado','info'); }
function confirmarPedidoAprov(id) { DB.aprovarPedido(id); renderAprovacoes(); updateBadges(); toast('Pedido confirmado!','success'); }
function rejeitarPedidoAprov(id) { DB.rejeitarPedido(id); renderAprovacoes(); updateBadges(); toast('Pedido cancelado','info'); }

// ============================================================
// CONVITES
// ============================================================
let conviteAtual = null;
function gerarConvite(tipo) {
  const cfg2=DB.getConfig();
  const ceo=(cfg2.ceoPerfil&&cfg2.ceoPerfil.nome)||Auth.getUtilizador()||'CEO';
  const conv = DB.gerarConvite('ceo', ceo, tipo);
  conviteAtual = conv;
  document.getElementById('conv-icon').textContent = tipo==='parceiro'?'ğŸ¤':'ğŸ‘¤';
  document.getElementById('conv-tipo-label').textContent = tipo==='parceiro'?'Convite de Parceiro':'Convite de Cliente';
  document.getElementById('conv-code').textContent = conv.code;
  document.getElementById('conv-url').textContent = conv.url;
  openModal('modal-convite');
  renderConvites(); updateBadges();
  toast('Convite gerado!','success');
}
function copiarConvite() {
  if(!conviteAtual)return;
  navigator.clipboard.writeText(conviteAtual.url).then(()=>toast('Link copiado!','success')).catch(()=>{
    const t=document.createElement('textarea'); t.value=conviteAtual.url; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); toast('Link copiado!','success');
  });
}
function partilharConvite() {
  if(!conviteAtual)return;
  const cfg2=DB.getConfig();
  const wa=cfg2.whatsapp||'244952100356';
  const tipo=conviteAtual.tipo==='parceiro'?'parceiro/afiliado':'cliente';
  const msg=encodeURIComponent(`OlÃ¡! Convido-te a juntar-te Ã  HepoMarket como ${tipo}.\n\nRegista-te aqui: ${conviteAtual.url}\n\nCÃ³digo de convite: ${conviteAtual.code}\n\nQualquer dÃºvida, contacta-me. HepoMarket â€” Renda Extra com SeguranÃ§a ğŸš€`);
  window.open(`https://wa.me/?text=${msg}`,'_blank');
}
function renderConvites() {
  const convites=DB.getConvites();
  document.getElementById('convites-list').innerHTML=convites.length?convites.map(c=>`
    <div class="invite-card" style="opacity:${c.usado?0.6:1}">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">
        <div>
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
            <span style="font-size:20px">${c.tipo==='parceiro'?'ğŸ¤':'ğŸ‘¤'}</span>
            <span class="invite-code">${c.code}</span>
            <span class="badge ${c.usado?'badge-orange':'badge-blue'}">${c.usado?'Usado':'Activo'}</span>
          </div>
          <div style="font-size:12px;color:var(--text-secondary);word-break:break-all">${c.url}</div>
          <div style="font-size:11px;color:var(--text-disabled);margin-top:4px">Criado ${formatarDataRelativa(c.criadoEm)} ${c.usado?'Â· Usado '+formatarDataRelativa(c.usadoEm):''}</div>
        </div>
        ${!c.usado?`<div style="display:flex;gap:6px"><button class="btn btn-secondary btn-sm" onclick="copiarLink('${c.url}')">ğŸ“‹ Copiar</button></div>`:''}
      </div>
    </div>`).join(''):`<div class="empty-state"><div class="empty-state-icon">ğŸ”—</div><div class="empty-state-title">Nenhum convite gerado ainda</div><div style="margin-top:8px;color:var(--text-secondary)">Clique nos botÃµes acima para gerar convites</div></div>`;
}
function copiarLink(url) { navigator.clipboard.writeText(url).then(()=>toast('Copiado!','success')).catch(()=>toast('NÃ£o foi possÃ­vel copiar','error')); }

// ============================================================
// BANCÃRIO
// ============================================================
function loadBancario() {
  const b=DB.getDadosBancarios();
  document.getElementById('bk-iban').value=b.iban||'';
  document.getElementById('bk-titular').value=b.titular||'';
  document.getElementById('bk-banco').value=b.banco||'';
  document.getElementById('bk-swift').value=b.swift||'';
  document.getElementById('bk-multicaixa').value=b.multicaixa||'';
  document.getElementById('bk-ref-multicaixa').value=b.referenciaMulticaixa||'';
  document.getElementById('bk-paypal').value=b.paypal||'';
  document.getElementById('bk-outro').value=b.outro||'';
  document.getElementById('bk-instrucoes').value=b.instrucoes||'';
  document.getElementById('bk-m-iban').checked=b.metodos&&b.metodos.iban!==false;
  document.getElementById('bk-m-multicaixa').checked=b.metodos&&b.metodos.multicaixa!==false;
  document.getElementById('bk-m-paypal').checked=b.metodos&&b.metodos.paypal;
  document.getElementById('bk-m-dinheiro').checked=b.metodos&&b.metodos.dinheiro!==false;
  updateBankPreview();
}
function updateBankPreview() {
  const iban=document.getElementById('bk-iban')||{}; const titular=document.getElementById('bk-titular')||{}; const banco=document.getElementById('bk-banco')||{};
  if(document.getElementById('bk-iban-display')) document.getElementById('bk-iban-display').textContent=(iban.value||'IBAN nÃ£o configurado');
  if(document.getElementById('bk-titular-display')) document.getElementById('bk-titular-display').textContent=(titular.value||'â€”');
  if(document.getElementById('bk-banco-display')) document.getElementById('bk-banco-display').textContent=(banco.value||'â€”');
}
function saveBancario() {
  const b={
    iban:document.getElementById('bk-iban').value, titular:document.getElementById('bk-titular').value,
    banco:document.getElementById('bk-banco').value, swift:document.getElementById('bk-swift').value,
    multicaixa:document.getElementById('bk-multicaixa').value, referenciaMulticaixa:document.getElementById('bk-ref-multicaixa').value,
    paypal:document.getElementById('bk-paypal').value, outro:document.getElementById('bk-outro').value,
    instrucoes:document.getElementById('bk-instrucoes').value,
    metodos:{ iban:document.getElementById('bk-m-iban').checked, multicaixa:document.getElementById('bk-m-multicaixa').checked, paypal:document.getElementById('bk-m-paypal').checked, dinheiro:document.getElementById('bk-m-dinheiro').checked }
  };
  DB.saveDadosBancarios(b); toast('Dados bancÃ¡rios guardados!','success');
}

// ============================================================
// MENSAGENS
// ============================================================
function renderMensagens() {
  const msgs=DB.getMensagens();
  document.getElementById('mensagens-list').innerHTML=msgs.map(m=>`
    <div class="card-solid" style="padding:16px;margin-bottom:12px;border-left:4px solid ${m.lida?'var(--border)':'var(--accent)'}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px">
        <div style="flex:1">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
            <span style="font-weight:700">${m.nome||'Visitante'}</span>
            ${!m.lida?'<span class="badge badge-blue">Novo</span>':''}
          </div>
          <div style="color:var(--text-secondary);line-height:1.5">${m.texto||''}</div>
          ${m.resposta?`<div style="margin-top:8px;padding:8px;background:var(--accent-light);border-radius:8px;font-size:13px"><b>CEO:</b> ${m.resposta}</div>`:''}
          <div style="font-size:12px;color:var(--text-disabled);margin-top:4px">${formatarDataRelativa(m.criadoEm)}</div>
        </div>
        <div style="display:flex;gap:6px">
          ${!m.lida?`<button class="btn btn-ghost btn-sm" onclick="marcarMsgLida('${m.id}')">âœ… Lida</button>`:''}
          ${m.nome&&m.nome!=='Visitante'?`<a href="https://wa.me/?text=${encodeURIComponent('OlÃ¡ '+m.nome+', recebemos a sua mensagem!')}" target="_blank" class="btn btn-success btn-sm">ğŸ“²</a>`:''}
        </div>
      </div>
    </div>`).join('')||`<div class="empty-state"><div class="empty-state-icon">âœ‰ï¸</div><div class="empty-state-title">Nenhuma mensagem</div></div>`;
}
function marcarMsgLida(id) { DB.marcarMensagemLida(id); renderMensagens(); updateBadges(); }

// ============================================================
// PERFIL CEO
// ============================================================
function loadPerfil() {
  cfg=DB.getConfig();
  const p=cfg.ceoPerfil||{};
  document.getElementById('ceo-nome-input').value=p.nome||'';
  document.getElementById('ceo-cargo-input').value=p.cargo||'';
  document.getElementById('ceo-tel-input').value=p.tel||'';
  document.getElementById('perfil-nome-display').textContent=p.nome||'CEO';
  document.getElementById('perfil-cargo-display').textContent=p.cargo||'CEO & Fundador';
  const av=document.getElementById('ceo-avatar-display');
  if(p.foto){ av.innerHTML=`<img src="${p.foto}" style="width:96px;height:96px;border-radius:50%;object-fit:cover">`; document.getElementById('btn-remover-foto').style.display='inline-flex'; }
  else { av.innerHTML=(p.nome||'M')[0]; document.getElementById('btn-remover-foto').style.display='none'; }
  document.getElementById('ceo-user-actual').value=Auth.getUtilizador();
}
function loadCeoFoto(e) {
  const f=e.target.files[0]; if(!f)return;
  imageParaBase64(f).then(b64=>{
    cfg=DB.getConfig(); if(!cfg.ceoPerfil)cfg.ceoPerfil={};
    cfg.ceoPerfil.foto=b64; DB.saveConfig(cfg);
    document.getElementById('ceo-avatar-display').innerHTML=`<img src="${b64}" style="width:96px;height:96px;border-radius:50%;object-fit:cover">`;
    document.getElementById('btn-remover-foto').style.display='inline-flex';
    updateTopbarCeo(); toast('Foto actualizada!','success');
  });
}
function removerCeoFoto() {
  cfg=DB.getConfig(); if(!cfg.ceoPerfil)cfg.ceoPerfil={};
  cfg.ceoPerfil.foto=null; DB.saveConfig(cfg);
  document.getElementById('ceo-avatar-display').innerHTML=(cfg.ceoPerfil.nome||'M')[0];
  document.getElementById('btn-remover-foto').style.display='none';
  updateTopbarCeo(); toast('Foto removida','info');
}
function salvarPerfil() {
  cfg=DB.getConfig(); if(!cfg.ceoPerfil)cfg.ceoPerfil={};
  cfg.ceoPerfil.nome=document.getElementById('ceo-nome-input').value;
  cfg.ceoPerfil.cargo=document.getElementById('ceo-cargo-input').value;
  cfg.ceoPerfil.tel=document.getElementById('ceo-tel-input').value;
  DB.saveConfig(cfg);
  document.getElementById('perfil-nome-display').textContent=cfg.ceoPerfil.nome;
  document.getElementById('perfil-cargo-display').textContent=cfg.ceoPerfil.cargo;
  document.getElementById('sidebar-brand').textContent=cfg.nomeEmpresa||'HepoMarket';
  updateTopbarCeo(); toast('Perfil actualizado!','success');
}
function alterarUtilizador() {
  const n=document.getElementById('new-user').value.trim(); if(!n){toast('Novo utilizador obrigatÃ³rio','error');return;}
  Auth.alterarUtilizador(n); document.getElementById('ceo-user-actual').value=n; document.getElementById('new-user').value='';
  updateTopbarCeo(); toast('Utilizador alterado!','success');
}
function alterarSenha() {
  const c=document.getElementById('current-pass').value; const n=document.getElementById('new-pass').value; const cf=document.getElementById('conf-pass').value;
  const creds=Auth._getCreds();
  if(c!==creds.pass){toast('Palavra-passe actual incorrecta','error');return;}
  if(n.length<6){toast('Nova palavra-passe deve ter mÃ­n. 6 caracteres','error');return;}
  if(n!==cf){toast('ConfirmaÃ§Ã£o nÃ£o coincide','error');return;}
  Auth.alterarSenha(n); document.getElementById('current-pass').value=''; document.getElementById('new-pass').value=''; document.getElementById('conf-pass').value='';
  toast('Palavra-passe alterada com sucesso!','success');
}
function confirmarReset() {
  if(confirm('âš ï¸ Isto vai apagar TODOS os dados (produtos, clientes, parceiros, pedidos...). Esta acÃ§Ã£o Ã© IRREVERSÃVEL. Confirma?')) {
    ['hm_produtos','hm_servicos','hm_clientes','hm_parceiros','hm_pedidos','hm_convites','hm_notificacoes','hm_mensagens','hm_banking'].forEach(k=>localStorage.removeItem(k));
    toast('Base de dados reposta.','info'); setTimeout(()=>goView('home'),800);
  }
}

// ============================================================
// CONFIGURAÃ‡Ã•ES
// ============================================================
const ACCENT_COLORS=['#0078D4','#107c10','#c42b1c','#d47f00','#8764b8','#038387','#e3008c','#cc5500','#004e8c','#1b1b1b'];
function loadConfig() {
  cfg=DB.getConfig();
  document.getElementById('cfg-nome').value=cfg.nomeEmpresa||'';
  document.getElementById('cfg-slogan').value=cfg.slogan||'';
  document.getElementById('cfg-wa').value=cfg.whatsapp||'';
  document.getElementById('cfg-tel').value=cfg.telefone||'';
  if(document.getElementById('cfg-endereco')) document.getElementById('cfg-endereco').value=cfg.endereco||'';
  if(document.getElementById('cfg-comissao')) document.getElementById('cfg-comissao').value=cfg.taxaComissao||10;
  document.getElementById('cfg-facebook').value=cfg.facebook||'';
  document.getElementById('cfg-instagram').value=cfg.instagram||'';
  document.getElementById('cfg-tiktok').value=cfg.tiktok||'';
  document.getElementById('cfg-youtube').value=cfg.youtube||'';
  // Cores
  document.getElementById('color-grid').innerHTML=ACCENT_COLORS.map(c=>`<div class="color-dot ${cfg.corAcento===c?'sel':''}" style="background:${c}" onclick="setAccentColor('${c}')"></div>`).join('');
  document.getElementById('custom-color').value=cfg.corAcento||'#0078D4';
  // Tema
  document.getElementById('btn-light').className='btn '+(cfg.tema==='light'?'btn-primary':'btn-secondary');
  document.getElementById('btn-dark').className='btn '+(cfg.tema==='dark'?'btn-primary':'btn-secondary');
  // Fundo
  document.getElementById('cfg-fundo-tipo').value=cfg.fundoTipo||'gradiente';
  document.getElementById('cfg-cor1').value=cfg.fundoCor1||'#e8f0fe';
  document.getElementById('cfg-cor2').value=cfg.fundoCor2||'#c2d4f8';
  updateBgPreview();
  if(cfg.fundoImagem){
    const pi=document.getElementById('bg-preview-img');
    pi.src=cfg.fundoImagem; pi.style.display='block';
    document.getElementById('bg-upload-label').style.display='none';
  }
  // novos campos hero
  const htc=cfg.heroTextoCor||'#ffffff';
  document.getElementById('cfg-hero-cor-texto').value=htc;
  const ov=cfg.heroOverlay!==false;
  document.getElementById('cfg-hero-overlay').checked=ov;
  const op=cfg.heroOverlayOpacity!==undefined?cfg.heroOverlayOpacity:0.45;
  document.getElementById('cfg-overlay-opac').value=op;
  document.getElementById('opac-val').textContent=Math.round(op*100)+'%';
}
function setAccentColor(c) {
  document.querySelectorAll('.color-dot').forEach(d=>d.classList.remove('sel'));
  event.target.classList.add('sel'); applyAccent(c);
  cfg=DB.getConfig(); cfg.corAcento=c; DB.saveConfig(cfg);
  toast('Cor actualizada!','success');
}
function setCustomColor() { const c=document.getElementById('custom-color').value; applyAccent(c); cfg=DB.getConfig(); cfg.corAcento=c; DB.saveConfig(cfg); toast('Cor personalizada aplicada!','success'); }
function setTema(t) { applyTheme(t); cfg=DB.getConfig(); cfg.tema=t; DB.saveConfig(cfg); loadConfig(); toast('Tema '+(t==='dark'?'escuro':'claro')+' activado','success'); }
function toggleTema() { const cur=document.documentElement.getAttribute('data-theme'); setTema(cur==='dark'?'light':'dark'); }
function saveEmpresa() {
  cfg=DB.getConfig();
  cfg.nomeEmpresa=document.getElementById('cfg-nome').value;
  cfg.slogan=document.getElementById('cfg-slogan').value;
  cfg.whatsapp=document.getElementById('cfg-wa').value;
  cfg.telefone=(document.getElementById('cfg-tel').value||cfg.telefone);
  if(document.getElementById('cfg-endereco')) cfg.endereco=document.getElementById('cfg-endereco').value;
  if(document.getElementById('cfg-comissao')) cfg.taxaComissao=document.getElementById('cfg-comissao').value;
  DB.saveConfig(cfg);
  document.getElementById('sidebar-brand').textContent=cfg.nomeEmpresa||'HepoMarket';
  toast('Dados da empresa guardados!','success');
}
function saveSociais() {
  cfg=DB.getConfig();
  cfg.facebook=document.getElementById('cfg-facebook').value;
  cfg.instagram=document.getElementById('cfg-instagram').value;
  cfg.tiktok=document.getElementById('cfg-tiktok').value;
  cfg.youtube=document.getElementById('cfg-youtube').value;
  DB.saveConfig(cfg); toast('Redes sociais guardadas!','success');
}
function updateBgPreview() {
  const tipo=(document.getElementById('cfg-fundo-tipo')||{}).value||'gradiente';
  const c1=(document.getElementById('cfg-cor1')||{}).value||'#e8f0fe';
  const c2=(document.getElementById('cfg-cor2')||{}).value||'#c2d4f8';
  const pb=document.getElementById('bg-preview-box'); if(!pb)return;
  document.getElementById('fundo-gradiente-opts').style.display=tipo==='imagem'?'none':'block';
  document.getElementById('fundo-img-opts').style.display=tipo==='imagem'?'block':'none';
  if(tipo==='gradiente') pb.style.background=`linear-gradient(135deg,${c1},${c2})`;
  else if(tipo==='cor-solida') pb.style.background=c1;
  else pb.style.background='var(--bg2)';
}
function loadBgImage(e) {
  const f = e.target.files[0]; if (!f) return;
  imageParaBase64(f).then(b64 => {
    const pi = document.getElementById('bg-preview-img');
    pi.src = b64; pi.style.display = 'block';
    document.getElementById('bg-upload-label').style.display = 'none';
    document.getElementById('bg-preview-box').style.background = 'url('+b64+') center/cover';
    toast('Imagem carregada! Clique em Guardar.', 'info');
  });
}
function saveFundo() {
  cfg = DB.getConfig();
  cfg.fundoTipo  = document.getElementById('cfg-fundo-tipo').value;
  cfg.fundoCor1  = document.getElementById('cfg-cor1').value;
  cfg.fundoCor2  = document.getElementById('cfg-cor2').value;
  // Imagem â€” guarda base64 e marca timestamp para forÃ§ar reload
  if (cfg.fundoTipo === 'imagem') {
    const img = document.getElementById('bg-preview-img');
    if (img && img.src && img.src.startsWith('data:')) {
      cfg.fundoImagem   = img.src;
      cfg.fundoImagemTs = Date.now(); // forÃ§a recarga no index.html
    }
  } else {
    // se mudou para gradiente/cor, limpa imagem anterior
    cfg.fundoImagem   = null;
    cfg.fundoImagemTs = null;
  }
  // novos campos hero
  cfg.heroTextoCor      = document.getElementById('cfg-hero-cor-texto').value;
  cfg.heroOverlay       = document.getElementById('cfg-hero-overlay').checked;
  cfg.heroOverlayOpacity = parseFloat(document.getElementById('cfg-overlay-opac').value);
  DB.saveConfig(cfg);
  applyFundo();
  toast('Fundo e texto guardados!', 'success');
}
function setHeroTextCor(cor) {
  document.getElementById('cfg-hero-cor-texto').value = cor;
}
function removerImagemFundo() {
  cfg = DB.getConfig();
  cfg.fundoImagem = null; cfg.fundoImagemTs = null;
  cfg.fundoTipo = 'gradiente';
  document.getElementById('cfg-fundo-tipo').value = 'gradiente';
  document.getElementById('bg-preview-img').src = '';
  document.getElementById('bg-preview-img').style.display = 'none';
  document.getElementById('bg-upload-label').style.display = '';
  DB.saveConfig(cfg); updateBgPreview(); applyFundo();
  toast('Imagem removida', 'info');
}

// ============================================================
// CUPÃ•ES DE DESCONTO
// ============================================================
function renderCupoes() {
  const todos   = Cupoes.getAll().sort((a,b)=>new Date(b.criadoEm)-new Date(a.criadoEm));
  const ativos  = todos.filter(c=>c.ativo).length;
  const usos    = todos.reduce((s,c)=>s+(c.usos||0),0);
  document.getElementById('cup-stats').innerHTML =
    '<div class="stat-card stat-accent"><div class="stat-icon">ğŸŸï¸</div><div class="stat-value">'+todos.length+'</div><div class="stat-label">CupÃµes Total</div></div>'+
    '<div class="stat-card stat-green"><div class="stat-icon">âœ…</div><div class="stat-value">'+ativos+'</div><div class="stat-label">Activos</div></div>'+
    '<div class="stat-card stat-orange"><div class="stat-icon">ğŸ“Š</div><div class="stat-value">'+usos+'</div><div class="stat-label">Usos Total</div></div>';

  if (!todos.length) {
    document.getElementById('cupoes-table').innerHTML =
      '<div class="empty-state"><div class="empty-state-icon">ğŸŸï¸</div><div class="empty-state-title">Nenhum cupÃ£o criado</div><div class="empty-state-subtitle">Clique em â• para criar o primeiro cupÃ£o</div></div>';
    return;
  }
  document.getElementById('cupoes-table').innerHTML =
    '<div class="table-wrap"><table class="table"><thead><tr>'+
    '<th>CÃ³digo</th><th>Tipo</th><th>Desconto</th><th>Usos</th><th>Validade</th><th>Estado</th><th>AcÃ§Ãµes</th>'+
    '</tr></thead><tbody>'+
    todos.map(c=>
      '<tr>'+
      '<td><span style="font-family:monospace;font-size:15px;font-weight:800;color:var(--accent);letter-spacing:1px">'+c.codigo+'</span></td>'+
      '<td>'+(c.tipo==='percentagem'?'ğŸ“‰ Percentagem':'ğŸ’° Valor Fixo')+'</td>'+
      '<td style="font-weight:700">'+(c.tipo==='percentagem'?c.valor+'%':formatarKz(c.valor))+'</td>'+
      '<td>'+(c.usos||0)+(c.maxUsos?' / '+c.maxUsos:' (ilimitado)')+'</td>'+
      '<td>'+(c.validade?formatarData(c.validade):'Sem limite')+'</td>'+
      '<td><span class="status-pill" style="'+(c.ativo?'background:rgba(16,124,16,.12);color:#107c10':'background:rgba(196,43,28,.12);color:#c42b1c')+'">'+(c.ativo?'âœ… Activo':'â›” Inactivo')+'</span></td>'+
      '<td><div style="display:flex;gap:4px">'+
        '<button class="btn btn-ghost btn-sm" onclick="copiarCupao(''+c.codigo+'')" title="Copiar cÃ³digo">ğŸ“‹</button>'+
        '<button class="btn btn-ghost btn-sm" onclick="toggleCupao(''+c.id+'')">'+(c.ativo?'â›”':'âœ…')+'</button>'+
        '<button class="btn btn-ghost btn-sm" onclick="openCupaoModal(''+c.id+'')">âœï¸</button>'+
        '<button class="btn btn-danger btn-sm" onclick="removeCupaoItem(''+c.id+'')">ğŸ—‘ï¸</button>'+
      '</div></td></tr>'
    ).join('')+
    '</tbody></table></div>';
}
let _cupEditId='';
function openCupaoModal(id) {
  _cupEditId=id||'';
  const c=id?Cupoes.getAll().find(x=>x.id===id):null;
  document.getElementById('cup-edit-id').value=_cupEditId;
  document.getElementById('cup-codigo').value=c?c.codigo:gerarCodigo();
  document.getElementById('cup-tipo').value=c?(c.tipo||'percentagem'):'percentagem';
  document.getElementById('cup-valor').value=c?c.valor:'';
  document.getElementById('cup-maxusos').value=c?(c.maxUsos||''):'';
  document.getElementById('cup-validade').value=c?(c.validade||''):'';
  document.getElementById('cup-ativo').checked=c?c.ativo:true;
  document.getElementById('cup-desc').value=c?(c.descricao||''):'';
  document.getElementById('modal-cup-title').textContent=id?'Editar CupÃ£o':'Novo CupÃ£o de Desconto';
  openModal('modal-cupao');
}
function gerarCodigo(){return'HEPO'+Math.random().toString(36).substring(2,6).toUpperCase();}
function saveCupao() {
  const codigo=(document.getElementById('cup-codigo').value||'').trim().toUpperCase();
  if(!codigo){toast('CÃ³digo obrigatÃ³rio','error');return;}
  const valor=parseFloat(document.getElementById('cup-valor').value);
  if(!valor||valor<=0){toast('Valor invÃ¡lido','error');return;}
  const id=document.getElementById('cup-edit-id').value;
  const data={
    codigo, tipo:document.getElementById('cup-tipo').value,
    valor, maxUsos:parseInt(document.getElementById('cup-maxusos').value)||null,
    validade:document.getElementById('cup-validade').value||null,
    ativo:document.getElementById('cup-ativo').checked,
    descricao:document.getElementById('cup-desc').value
  };
  if(id)Cupoes.update(id,data);else Cupoes.add(data);
  closeModal('modal-cupao');renderCupoes();updateBadges();toast('CupÃ£o guardado!','success');
}
function toggleCupao(id){const c=Cupoes.getAll().find(x=>x.id===id);if(c){Cupoes.update(id,{ativo:!c.ativo});renderCupoes();toast(c.ativo?'Desactivado':'Activado!','info');}}
function removeCupaoItem(id){if(confirm('Remover cupÃ£o?')){Cupoes.remove(id);renderCupoes();updateBadges();toast('Removido','info');}}
function copiarCupao(cod){navigator.clipboard.writeText(cod).then(()=>toast('Copiado: '+cod,'success')).catch(()=>{});}

// ============================================================
// INIT
// ============================================================
window.addEventListener('hm_update', ()=>updateBadges());
updateBadges();
renderHome();
loadConfig();
</script>
</body>
</html>
